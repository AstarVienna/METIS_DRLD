
\subsection{ADI observing mode}\label{sec:drl_functions_adi}

%---------------------------------------------------------------------

%lm_adi_cgrph_centroid

\subsubsection{Detect centroid in LM images}\label{drl:metis_lm_adi_cgrph_centroid}
\begin{recipedef}
Name: & \DRL{metis_lm_adi_cgrph_centroid} \\
Purpose: & Detect the centroid in a sequence of LM band CVC/RAVC coronographic images\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: &\texttt{metis\_imagelist *input} \\
Other inputs: & \EXTCALIB{LM_ON_AXIS_PSF_TEMPLATE} \\
QC outputs: & \QC{QC LM cgrph SCI FWHM nn}\\
%Output FITS files: & None \\
Outputs: & \texttt{cpl\_table *centroid} (\PROD{lm_cgrph_CENTROID_TAB})\\
         & \texttt{cpl\_error\_code} \\
General description: & Centroiding of source in LM band coronagraphic images \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging}  \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%n_adi_cgrph_centroid

\subsubsection{Detect centroid in N images}\label{drl:metis_n_adi_cgrph_centroid}
\begin{recipedef}
Name: & \DRL{metis_n_adi_cgrph_centroid} \\
Purpose: & Detect the centroids in a sequence of N band CVC/RAVC coronographic images\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: &\texttt{metis\_imagelist *input} \\
Other inputs: & \EXTCALIB{N_ON_AXIS_PSF_TEMPLATE} \\
%Other inputs: & None \\
QC outputs: & \QC{QC N cgrph SCI FWHM nn}\\
%Output FITS files: & None \\
Outputs: & \texttt{cpl\_table *centroid} (\PROD{n_cgrph_CENTROID_TAB})\\
         & \texttt{cpl\_error\_code} \\
General description: & Centroiding of source in N band coronagraphic images \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging}  \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%lm_adi_app_centroid

\subsubsection{Detect centroid in APP LM images}\label{drl:metis_lm_adi_app_centroid}
\begin{recipedef}
Name: & \DRL{metis_lm_adi_app_centroid} \\
Purpose: & Determine the centroid in a sequence of LM band APP coronographic images\\
Used in recipes: & \REC{metis_lm_adi_app}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: &\texttt{metis\_imagelist *input} \\
Other inputs: & \EXTCALIB{LM_ON_AXIS_PSF_TEMPLATE}\\
%Other inputs: & None \\
QC outputs: & \QC{QC LM APP SCI FWHM nn}\\
%Output FITS files: & None \\
Outputs: & \texttt{cpl\_table *centroid} (\PROD{lm_app_CENTROID_TAB})\\
         & \texttt{cpl\_error\_code} \\
General description: & Determine source location in LM band APP coronagraphic images, through the \ac{WFS-FS} position and by centroiding \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging}  \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%n_adi_app_centroid
% HB 20230627: There is no APP in the N-band right?
% \subsubsection{Detect centroid in APP N images}\label{drl:n_adi_app_centroid}
% \begin{recipedef}
% Name: & \DRL{n_adi_app_centroid} \\
% Purpose: & Detect the centroids in a sequence of N band APP coronographic images\\
% Used in recipes: & \REC{metis_lm_adi_app}\\
% %Working remarks: & None \\
% %Function Parameters: & None \\
% Input: &\texttt{metis\_imagelist *input} \\
% %Other inputs: & None \\
% QC outputs: & QC N APP FWHM nn\\
% %Output FITS files: & None \\
% Outputs: & \PROD{n_app_CENTROID_TAB}\\
%                 & \texttt{cpl\_error\_code} \\
% General description: & Centroiding of source in N band APP coronagraphic images \\
% Mathematical description: & see Section~\ref{ssec:algo_app_imaging}  \\
% Quality assessment: & Through QC parameters \\
% Error conditions: & See~\cite{DRLVT}. \\
% Unit tests: & See~\cite{DRLVT}. \\
% \end{recipedef}


%lm_adi_cgrph_psf

\subsubsection{Calculate median PSF for ADI LM band}\label{drl:metis_lm_adi_cgrph_psf}

\begin{recipedef}
Name: & \DRL{metis_lm_adi_cgrph_psf} \\
Purpose: & Calculate median PSF for sequence of ADI images\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
Function Parameters: & combination method (median, mean, sigma clipped...)\\
                     & parameters for combination method\\
Input: &\texttt{metis\_imagelist *input} \\
       & \texttt{cpl\_table *centroid} (\PROD{lm_cgrph_CENTROID_TAB})\\
%Other inputs: & None \\
QC outputs: & \QC{QC det cgrph SCI FWHM nn}\\
%Output FITS files: & None \\
Outputs: & \texttt{metis\_image *psf\_median} (\PROD{lm_cgrph_PSF_MEDIAN})\\
         & \texttt{cpl\_error\_code} \\
General description: & Calculation of median PSF for sequence of ADI images\ \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%n_adi_cgrph_psf

\subsubsection{Calculate median PSF for ADI N band}\label{drl:metis_n_adi_cgrph_psf}
\begin{recipedef}
Name: & \DRL{metis_n_adi_cgrph_psf} \\
Purpose: & Calculate median PSF for sequence of ADI images\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
Function Parameters: & combination method (median, mean, sigma clipped...)\\
                     & parameters for combination method\\
Input: &\texttt{metis\_imagelist *input} \\
       & \texttt{cpl\_table *centroid} (\PROD{n_cgrph_CENTROID_TAB})\\
%Other inputs: & None \\
QC outputs: & \QC{QC det cgrph SCI FWHM nn}\\
%Output FITS files: & None \\
Outputs: & \texttt{metis\_image *psf\_median} (\PROD{n_cgrph_PSF_MEDIAN})\\
         & \texttt{cpl\_error\_code} \\
General description: & Calculation of median PSF for sequence of ADI images\ \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%lm_adi_cgrph_psf

\subsubsection{Calculate median PSF for APP LM band}\label{drl:metis_lm_adi_app_psf}
\begin{recipedef}
Name: & \DRL{metis_lm_adi_app_psf} \\
Purpose: & Calculate median PSF for sequence of ADI images\\
Used in recipes: & \REC{metis_lm_adi_app}\\
%Working remarks: & None \\
Function Parameters: & combination method (median, mean, sigma clipped...)\\
                     & parameters for combination method\\
Input: &\texttt{metis\_imagelist *input} \\
       & \texttt{cpl\_table *centroid} (\PROD{LM_app_CENTROID_TAB})\\
%Other inputs: & None \\
QC outputs: & \QC{QC det APP SCI FWHM nn}\\
%Output FITS files: & None \\
Outputs: & \texttt{metis\_image *psf\_median} (\PROD{lm_app_PSF_MEDIAN})\\
         & \texttt{cpl\_error\_code} \\
General description: & Calculation of median PSF for sequence of ADI images\ \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%n_adi_app_psf
% HB 20230627: There is no APP in the N-band right?
% \subsubsection{Calculate median PSF for APP N band}\label{drl:n_adi_app_psf}
% \begin{recipedef}
% Name: & \DRL{n_adi_app_psf} \\
% Purpose: & Calculate median PSF for sequence of ADI images for the APP coronograph\\
% Used in recipes: & \REC{metis_lm_adi_app}\\
% %Working remarks: & None \\
% Function Parameters: & combination method (median, mean, sigma clipped...)\\
%                      & parameters for combination method\\
% Input: &\texttt{hdrl\_imagelist *input} \\
%        &  \PROD{n_app_CENTROID_TAB}\\
% %Other inputs: & None \\
% QC outputs: & QC det APP SCI FWHM nn\\
% %Output FITS files: & None \\
% Outputs: & \PROD{n_app_PSF\_MEDIAN}\\
%                 & \texttt{cpl\_error\_code} \\
% General description: & Calculation of median PSF for sequence of ADI images  for the APP coronograph \\
% Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
% Quality assessment: & Through QC parameters \\
% Error conditions: & See~\cite{DRLVT}. \\
% Unit tests: & See~\cite{DRLVT}. \\
% \end{recipedef}

%n_adi_app_psf

\subsubsection{Merge PSFs for LM band APP image}\label{drl:metis_lm_merge_app_adi_psf}\label{drl:metis_lm_merge_app_psf}
\begin{recipedef}
Name: & \DRL{metis_lm_merge_app_psf} \\
Purpose: & Merge the components of the PSF for an LM band APP coronagraph image\\
Used in recipes: & \REC{metis_lm_adi_app}\\
%Working remarks: & None \\
Function Parameters: & combination method (median, mean, sigma clipped...)\\
                     & parameters for combination method\\
Input: &\texttt{metis\_imagelist *input} \\
%Other inputs: & None \\
QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & \texttt{metis\_image *output} (merged PSF) \\
         & \texttt{cpl\_error\_code} \\
General description: & Merge the components of the PSF for an LM band APP coronagraph image \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

% NO N-band APP
%\subsubsection{Merge PSFs for N band APP image}\label{drl:n_merge_app_adi_psf}
%\begin{recipedef}
%Name: & \DRL{n_merge_app_psf} \\
%Purpose: & Merge the components of the PSF for an N band APP coronagraph image\\
%Used in recipes: & \REC{metis_lm_adi_app}\\
%Working remarks: & None \\
%Function Parameters: & combination method (median, mean, sigma clipped...)\\
                     %& parameters for combination method\\
%Input: &\texttt{hdrl\_imagelist *input} \\
%Other inputs: & None \\
%QC outputs: & None \\
%Output FITS files: & None \\
%Outputs: & \texttt{cpl\_error\_code} \\
%General description: & Merge the components of the PSF for an N band APP coronagraph image \\
%Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
%Quality assessment: & Through QC parameters \\
%Error conditions: & See~\cite{DRLVT}. \\
%Unit tests: & See~\cite{DRLVT}. \\
%\end{recipedef}

%apply distortion correcton and regrid

\subsubsection{Apply distortion correction}\label{drl:metis_adi_regrid}
\begin{recipedef}
Name: & \DRL{metis_adi_regrid} \\
Purpose: & Apply distortion correction and regrid to align images\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
Function Parameters: & Resampling method\\
                     & parameters for resampling method\\
Input: &\texttt{metis\_imagelist *input} \\
       & \texttt{cpl\_table *centroid} (\PROD{det_cgrph_CENTROID_TAB})\\
       & \texttt{cpl\_table *disttab} (\PROD{det_DISTORTION_TABLE})\\
%Other inputs: & Parameters for regridding \\
QC outputs: & None\\
Outputs: & \texttt{metis\_image *output} (\PROD{det_cgrph_SCI_CENTRED}) \\
         & \texttt{cpl\_error\_code} \\
General description: & Apply the distortion correction and align images on a subpixel scale \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%apply distortion correcton and regrid

\subsubsection{Regrid IFU image}\label{drl:metis_ifu_adi_regrid}
\begin{recipedef}
Name: & \DRL{metis_ifu_adi_regrid} \\
Purpose: & Apply distortion correction, perform square pixel reconstruction, and regrid to align images\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
Function Parameters: & Resampling method\\
                     & parameters for resampling method\\
Input: & \texttt{metis\_imagelist *input} \\
       & \texttt{cpl\_table *centroid} (\PROD{det_cgrph_CENTROID_TAB})\\
       & \texttt{cpl\_table *disttab} (\PROD{det_DISTORTION_TABLE})\\
%Other inputs: & Parameters for regridding \\
QC outputs: & None\\
Outputs: & \texttt{metis\_image *output} \PROD{det_cgrph_SCI_CENTRED} \\
         &   \texttt{cpl\_error\_code} \\
General description: & Apply the distortion correction, perform square pixel reconstruction, and align images on a subpixel scale \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%derotate images

\subsubsection{Derotate ADI images}\label{drl:metis_adi_derotate}
\begin{recipedef}
Name: & \DRL{metis_adi_derotate} \\
Purpose: & Derotate a sequence of coronagraphic images\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
Function Parameters: method for resampling\\
Input: &\texttt{metis\_imagelist *input} \\
%Other inputs: & None \\
QC outputs: & \QC{QC det cgrph SCI SNR MEAN} \\
            & \QC{QC det cgrph SCI SNR PEAK} \\
Outputs: & \texttt{metis\_image *output} (\PROD{det_cgrph_SCI_DEROTATED_PSFSUB}) \\
         & \texttt{metis\_image *output}  \PROD{det_cgrph_SCI_DEROTATED} \\
         & \texttt{metis\_image *psf\_median} (\PROD{det_cgrph_PSF_MEDIAN})\\
         & \texttt{cpl\_error\_code} \\
General description: & derotate a sequence of ADI images \\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%calculate lm contrast curve 

\subsubsection{Calculate contrast curve for LM band}\label{drl:metis_lm_adi_cgrph_contrast}
\begin{recipedef}
Name: & \DRL{metis_lm_adi_cgrph_contrast} \\
Purpose: & Calculate contrast curves for a sequence of LM band coronagraphic images, for the RAVC/CVC coronagraph\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
Function Parameters: None \\
Input: &\texttt{metis\_imagelist *input} \\
       & \texttt{metis\_image *input} (Off-axis PSF reference) \\
QC outputs: & \QC{QC LM cgrph SCI CONTRAST RAW LAMD}\\
            & \QC{QC LM cgrph SCI CONTRAST ADI LAMD}\\
  Outputs: & \texttt{hdrl\_spectrum1D *output} (\PROD{LM_cgrph_SCI_CONTRAST_RADPROF}) \\
           & \texttt{hdrl\_spectrum1D *output} (\PROD{LM_cgrph_SCI_CONTRAST_ADI}) \\
           & \texttt{hdrl\_spectrum1D *throughput} (\PROD{LM_cgrph_SCI_THROUGHPUT})\\
           & \texttt{cpl\_error\_code} \\
General description: &  Calculate contrast curves for a sequence of LM band coronagraphic images, for the  RAVC/CVC coronagraph\\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%calculate n contrast curve 

\subsubsection{Calculate contrast curve for N band}\label{drl:metis_n_adi_cgrph_contrast}
\begin{recipedef}
Name: & \DRL{metis_n_adi_cgrph_contrast} \\
Purpose: & Calculate contrast curves for a sequence of N band coronagraphic images, for the RAVC/CVC coronagraph\\
Used in recipes: & \REC{metis_img_adi_cgrph}\\
%Working remarks: & None \\
Function Parameters: None \\
Input: &\texttt{metis\_imagelist *input} \\
       & \texttt{metis\_image *input} (Off-axis PSF reference) \\
QC outputs: & \QC{QC N cgrph SCI CONTRAST RAW LAMD}\\
            & \QC{QC N cgrph SCI CONTRAST ADI LAMD}\\
  Outputs: & \texttt{hdrl\_spectrum1D *output} (\PROD{N_cgrph_SCI_CONTRAST_RADPROF}) \\
           & \texttt{hdrl\_spectrum1D *output} (\PROD{N_cgrph_SCI_CONTRAST_ADI}) \\
           & \texttt{hdrl\_spectrum1D *throughput} (\PROD{N_cgrph_SCI_THROUGHPUT}) \\
           & \texttt{cpl\_error\_code} \\
General description: &  Calculate contrast curves for a sequence of N band coronagraphic images, for the  RAVC/CVC coronagraph\\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%calculate lm contrast curve 

\subsubsection{Calculate contrast curve for APP LM band}\label{drl:metis_lm_adi_app_contrast}
\begin{recipedef}
Name: & \DRL{metis_lm_adi_app_contrast} \\
Purpose: & Calculate contrast curves for a sequence of LM band coronagraphic images, for the APP coronagraph\\
Used in recipes: & \REC{metis_lm_adi_app}\\
%Working remarks: & None \\
Function Parameters: None \\
Input: &\texttt{metis\_imagelist *input} \\
       & \texttt{metis\_image *psf} (Off-axis PSF reference) \\
QC outputs: & \QC{QC det APP SCI CONTRAST RAW LAMD}\\
& \QC{QC det APP SCI CONTRAST ADI LAMD}\\
  Outputs: & \texttt{hdrl\_spectrum1D *output} (\PROD{LM_APP_SCI_CONTRAST_RADPROF}) \\
           & \texttt{hdrl\_spectrum1D *output} (\PROD{LM_APP_SCI_CONTRAST_ADI}) \\
           & \texttt{hdrl\_spectrum1D *throughput} (\PROD{LM_APP_SCI_THROUGHPUT}) \\
           & \texttt{cpl\_error\_code} \\
General description: &  Calculate contrast curves for a sequence of LM band coronagraphic images, for the  APP coronagraph\\
Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


\subsubsection{High-pass filtering of PSF Subtracted Data}\label{drl:metis_adi_highpass_filter}
\begin{recipedef}
Name: & \DRL{metis_adi_highpass_filter} \\
Purpose: & Perform high pass-filtering of PSF subtracted data to improve noise characteristics.\\
Used in recipes: & \REC{metis_lm_adi_app}, \REC{metis_img_adi_cgrph}, \REC{metis_ifu_adi_cgrph} \\
%Working remarks: & None \\
Function Parameters: & filtering method (median, laplace) \\
                     & filter width\\
Input: &\texttt{metis\_imagelist *input} \\
QC outputs: & None \\
Outputs: & \texttt{metis\_imagelist *output} (images updated with the filtered data)
\texttt{metis\_imagelist *output} (\PROD{LM_CGRPH_SCI_HIFILT}) or \\
         & \texttt{metis\_imagelist *output} (\PROD{N_CGRPH_SCI_HIFILT}) or \\
         & \texttt{metis\_imagelist *output} (\PROD{IFU_CGRPH_SCI_HIFILT}) \\
           & \texttt{cpl\_error\_code} \\
General description: &  Perform high pass-filtering of PSF subtracted data to improve noise characteristics. The image(s) are updated, while the optional output to FITS file is the component subtracted from the input image(s).  \\
Mathematical description: & see Section~\ref{adi_highfilt} \\
Quality assessment: & N/A \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%calculate n contrast curve NO N-band APP

%\subsubsection{Calculate contrast curve for N APP images}\label{drl:xn_adi_app_contrast}
%\begin{recipedef}
%Name: & \DRL{n_adi_app_contrast} \\
%Purpose: & Calculate contrast curves for a sequence of N band coronagraphic images, for the APP coronagraph\\
%Used in recipes: & \REC{metis_lm_adi_app}\\
%Working remarks: & None \\
%Function Parameters: None \\
%Input: &\texttt{hdrl\_imagelist *input} \\
%Other inputs: & Off-axis PSF reference \\
%QC outputs: & QC det APP SCI CONTRAST RAW LAMD\\
            %& QC det APP SCI CONTRAST ADI LAMD\\
  %Output FITS files: & \PROD{LM_APP_SCI_CONTRAST_RADPROF} \\
                     %& \PROD{LM_APP_SCI_CONTRAST_ADI} \\
                     %& \PROD{LM_APP_SCI_THROUGHPUT} \\
%Outputs: & \texttt{cpl\_error\_code} \\
%General description: &  Calculate contrast curves for a sequence of N band coronagraphic images, for the  APP coronagraph\\
%Mathematical description: & see Section~\ref{ssec:algo_app_imaging} \\
%Quality assessment: & Through QC parameters \\
%Error conditions: & See~\cite{DRLVT}. \\
%Unit tests: & See~\cite{DRLVT}. \\
%\end{recipedef}

