\input{recipe_config}

\begin{tikzpicture}
  [x=1cm,
  y=-1cm,
  align=center,
  node distance=2cm and 3cm]
  \sffamily

  %% Grid for orientation. Comment out for final figure!
  %\draw[help lines, green](-5, 0) grid (8, 21);

  %%% Put workflow commands here:
  %% Main reduction workflow

  \node (template) [template]{%
    METIS\_ifu\_obs\_$\ast$ \\
    METIS\_ifu\_ext\_obs\_$\ast$ \\
    METIS\_ifu\_$\langle$hci$\rangle$\_obs\_$\ast$ \\
    METIS\_ifu\_ext\_$\langle$hci$\rangle$\_obs\_$\ast$ \\
    METIS\_ifu\_cal\_psf
  };

  \pic (start) [below=0.75cm of template] {start};

  \node (input) [below=0.75cm of start-m, input]{%
    \textsl{N} IFU\_SCI\_RAW
  };

  \node (step1) [below=2cm of input, redstep]{%
    detector signature\\
    removal
  };

  \node (step2)[below=0.7cm of step1, redstep]{%
    background\\
    subtraction
  };

  \node (step3)[below=0.7cm of step2, redstep]{%
    flux calibration
  };

  \node (step4) [below=0.7cm of step3, redstep]{%
    rectification
  };

  \node (step5) [below=0.7cm of step4, redstep]{%
    Image\,reconstruction
  };

  \node (step6) [below=0.7cm of step5, redstep]{%
    1D extraction
  };

  \node (step7) [below=0.7cm of step6, redstep]{%
    telluric correction
  };

  \pic (stop) [below=1.5cm of step7]{stop};

  %% Connections
  \draw (template) -- (input);
  \draw (input) -- (step1);
  \draw (step1) -- (step2);
  \draw (step2) -- (step3);
  \draw (step3) -- (step4);
  \draw (step4) -- (step5);
  \draw (step5) -- (step6);
  \draw (step6) -- (step7);
  \draw (step7) -- (stop-t);

  %% Input
  \node (connectpers) [connection] at
  ($(input)!0.35!(step1)$) {};
  \node (persistence) [left=3.95cm of connectpers, external]{%
    PERSISTENCE\_MAP
  };
  \draw [-](persistence) -- (connectpers);

  % Input for detector signature removal (step1)
  \node (bpmin) [left=2cm of step1, yshift=0.8cm, calproduct]{%
    BADPIX\_MAP\_IFU
  };
  \draw (bpmin.east) -- ++(1., 0) -- ++(0., 0.6) -- ++(1., 0);

  \node (darkin) [left=2cm of step1, calproduct] {%
    MASTER\_DARK\_IFU
  };
  \draw (darkin) -- (step1);

  \node (flatin) [left=2cm of step1, yshift=-0.8cm, calproduct]{%
    MASTER\_FLAT\_IFU
  };
  \draw (flatin.east) -- ++(1., 0) -- ++(0., -0.6) -- ++(1., 0);

  % Input for flux calibration (step3)
  \node (fcalin) [left=2cm of step3, calproduct]{%
    FLUXCAL\_TAB
  };
  \draw (fcalin) -- (step3);

  % Input for rectification (step4)
  \node (wavecal) [left=2cm of step4, yshift=0.4cm, calproduct]{%
    IFU\_WAVECAL
  };
  \draw (wavecal.east) -- ++(1., 0) -- ++(0., 0.3) -- ++(1., 0);

  \node (distortion) [left=2cm of step4, yshift=-0.4cm, calproduct]{%
    IFU\_DISTORT\_TAB
  };
  \draw (distortion.east) -- ++(1., 0) -- ++(0., -0.3) -- ++(1., 0);

  % Further input
  \node (molecparams) [left=2cm of step7, params]{%
    molecfit parameters
  };
  \draw (molecparams) -- (step7);


  %% Output

  % Output of background subtraction (step2)
  \node (backgroundreduced) [right=1.cm of step2, calproduct]{%
    SCI\_BACKGROUND
  };
  \draw (step2) -- (backgroundreduced);

  % Output of flux calibration (step3)
  \node (sci_reduced) [right=1cm of step3, sciproduct]{%
    SCI\_REDUCED
  };
  \draw (step3) -- (sci_reduced);

  % Output of rectification (step4)
  \node (sci_reduced_cube) [right=1cm of step4, sciproduct]{%
    SCI\_REDUCED\_CUBE
  };
  \draw (step4) -- (sci_reduced_cube);

  % Output of image reconstruction (step5)
  \node (sci_combined) [right=1cm of step5, sciproduct]{%
    SCI\_COMBINED
  };
  \draw (step5) -- (sci_combined);

  % Output of 1d extraction (step6)
  \node (sci_object) [right=1cm of step6, sciproduct]{%
    SCI\_OBJECT
  };
  \draw (step6) -- (sci_object);

  % Output of telluric correction (step7)
  \node (sci_reduced_tac) [right=1cm of step7, sciproduct]{%
    SCI\_REDUCED\_TAC
  };
  \draw (step7) -- (sci_reduced_tac);

  %% Frame around recipe
  \draw [frame] ($(input)!0.5!(step1) - (3.5,0)$)
  rectangle ($(step7)!0.5!(stop-t) + (2.5,0)$);
  \node [framecolor, anchor=north west] at
  ($(input)!0.5!(step1) - (3.5, 0)$) {%
    \textsl{metis\_ifu\_sci\_process}};

\end{tikzpicture}
