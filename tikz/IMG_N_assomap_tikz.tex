%% IMG_N_assomap_tikz.tex
%% Created by Oliver Czoske
%%
%% 2019-02-26: Changed to NQ only
%% 2019-02-26: Try to align it with the recipe flow
%% 2020-09-07: Pipeline redesign, N only

\sffamily

%%% Picture: flow chart
\begin{tikzpicture}[on grid=false,node distance=0.8cm]

  \matrix (recipes) [column sep=5mm, row sep=1cm]{
    % The matrix has colums
    % lin_*, dist_*, dark_*, flat_*, chop_*, std_*, cal_*, rest_*
    %
    % The matrix has rows
    % *_raw, *_lin, *_dark, *_flat, *_std, *_sci1, *_sci2, *_prod

    % Row *_raw
    \node[above] (lin_raw){\recipebox{DETLIN}{det\_detlin}}; &
    \node[above] (pers_raw){\recipebox{PERSISTENCE}{persistence\_map}}; &
    \node[above] (dist_raw){\recipebox{DISTORTION}{n\_img\_distortion}}; &
    \node[above] (dark_raw){\recipebox{DARK}{det\_dark}}; &
    \node[above] (flat_raw){\recipebox{FLAT}{n\_img\_flat}}; &
    \node[above] (chop_raw){\recipebox{CHOPNOD}{n\_img\_chopnod}}; &
    \node[above] (std_raw){\recipebox{PHOT STD}{n\_img\_std\_process}}; &
    \node[above] (cal_raw){\recipebox{SCIENCE}{n\_img\_sci\_calibrate}}; &
    \node[above] (rest_raw){\recipebox{SCIENCE}{n\_img\_restore}}; \\

    %%% Calibration products
    % Row *_lin
    \node (lin_lin)[statcalfile]{\NEWSTATCALIB{LINEARITY_GEO}}; &
    \node (pers_lin)[empty]{}; &
    \node (dist_lin)[empty]{}; &
    \node (dark_lin)[empty]{}; &
    \node (flat_lin)[connection]{}; &
    \node (chop_lin)[connection]{}; &
    \node (std_lin)[empty]{}; &
    \node (cal_lin)[empty]{}; &
    \node (rest_lin)[empty]{}; \\

    % Row persistence
    \node (lin_pers)[empty]{}; &
    \node (pers_pers)[extcalfile]{\NEWSTATCALIB{PERSISTENCE_MAP}}; &
    \node (dist_pers)[empty]{}; &
    \node (dark_pers)[empty]{}; &
    \node (flat_pers)[connection]{}; &
    \node (chop_pers)[connection]{}; &
    \node (std_pers)[empty]{}; &
    \node (cal_pers)[empty]{}; &
    \node (rest_pers)[empty]{}; \\

    %%% Calibration products
    % Row *_dark
    \node (lin_dark)[empty]{}; &
    \node (pers_dark)[empty]{}; &
    \node (dist_dark)[empty]{}; &
    \node (dark_dark)[qcproduct]{\NEWSTATCALIB{MASTER_DARK_GEO}}; &
    \node (flat_dark)[connection]{}; &
    \node (chop_dark)[empty]{}; &
    \node (std_dark)[empty]{}; &
    \node (cal_dark)[empty]{}; &
    \node (rest_dark)[empty]{}; \\

    % Row *_flat
    \node (lin_flat)[empty]{}; &
    \node (pers_flat)[empty]{}; &
    \node (dist_flat) [empty]{}; &
    \node (dark_flat)[empty]{}; &
    \node (flat_flat) [qcproduct]{\NEWSTATCALIB{MASTER_IMG_FLAT_LAMP_N}}; &
    \node (chop_flat)[connection]{}; &
    \node (std_flat)[empty]{}; &
    \node (cal_flat)[empty]{}; &
    \node (rest_flat) [empty]{}; \\

    % Row *_chopstd
    \node (lin_chopstd)[empty]{}; &
    \node (pers_chopstd)[empty]{}; &
    \node (dist_chopstd) [empty]{}; &
    \node (dark_chopstd)[empty]{}; &
    \node (flat_chopstd) [empty]{}; &
    \node (chop_chopstd)[calibproduct]{\NEWPROD{N_STD_BKG_SUBTRACTED}}; &
    \node (std_chopstd)[connection]{}; &
    \node (cal_chopstd)[empty]{}; &
    \node (rest_chopstd) [empty]{}; \\

    % Row *_chopsci
    \node (lin_chopsci)[empty]{}; &
    \node (pers_chopsci)[empty]{}; &
    \node (dist_chopsci) [empty]{}; &
    \node (dark_chopsci)[empty]{}; &
    \node (flat_chopsci) [empty]{}; &
    \node (chop_chopsci)[scienceproduct]{\NEWPROD{N_SCI_BKG_SUBTRACTED}}; &
    \node (std_chopsci)[empty]{}; &
    \node (cal_chopsci)[connection]{}; &
    \node (rest_chopsci) [empty]{}; \\

    % Row *_std
    \node (lin_std) [empty]{}; &
    \node (pers_std) [empty]{}; &
    \node (dist_std)[empty]{}; &
    \node (dark_std)[extcalfile]{\NEWEXTCALIB{FLUXSTD_CATALOG}}; &
    \node (flat_std)[empty]{}; &
    \node (chop_std)[empty]{}; &
    \node (std_std)[connection]{}; &
    \node (cal_std)[empty]{}; &
    \node (rest_std) [empty]{}; \\

    % Row *_cal
    \node (lin_cal)[empty]{}; &
    \node (pers_cal)[empty]{}; &
    \node (dist_cal) [empty]{}; &
    \node (dark_cal)[empty]{}; &
    \node (flat_cal)[empty]{}; &
    \node (chop_cal)[empty]{}; &
    \node (std_cal)[calibproduct]{\NEWPROD{FLUXCAL_TAB}}; &
    \node (cal_cal)[connection]{}; &
    \node (rest_cal) [empty]{}; \\

    % Row *_dist
    \node (lin_dist)[empty]{}; &
    \node (pers_dist)[empty]{}; &
    \node (dist_dist)[statcalfile]{\NEWSTATCALIB{N_DISTORTION_TABLE}}; &
    \node (dark_dist)[empty]{}; &
    \node (flat_dist)[empty]{}; &
    \node (chop_dist)[empty]{}; &
    \node (std_dist)[empty]{}; &
    \node (cal_dist)[connection]{}; &
    \node (rest_dist)[empty]{}; \\


    % Row *_rest
    \node (lin_rest)[empty]{}; &
    \node (pers_rest)[empty]{}; &
    \node (dist_rest)[empty]{}; &
    \node (dark_rest)[empty]{}; &
    \node (flat_rest)[empty]{}; &
    \node (chop_rest)[empty] {}; &
    \node (std_rest)[empty]{}; &
    \node (cal_rest)[scienceproduct]{\NEWPROD{N_SCI_CALIBRATED}}; &
    \node (rest_rest) [connection]{}; \\

    % Row *_prod
    \node (lin_prod)[empty]{}; &
    \node (pers_prod)[empty]{}; &
    \node (dist_prod)[empty]{}; &
    \node (dark_prod)[empty]{}; &
    \node (flat_prod)[empty]{}; &
    \node (chop_prod)[empty]{}; &
    \node (std_prod)[empty]{}; &
    \node (cal_prod) [empty]{}; &
    \node (rest_prod)[scienceproduct]{\NEWPROD{N_SCI_RESTORED}};
    \\
    & & & & & \\
  };    % end matrix

  \node (t1) at ($(dist_raw)!0.5!(dark_raw)$){};
  \node (t2) at ($(dist_prod)!0.5!(dark_prod)$){} ;
  \draw [thick,dashed] ([yshift=8mm]t1.north) -- ([yshift=-8mm]t2.south);

  %% Vertical connections
  \draw [arrow] (lin_raw) -- (lin_lin);
  \draw [arrow] (pers_raw) -- (pers_pers);
  \draw [arrow] (dark_raw) -- (dark_dark);
  \draw [arrow] (flat_raw) -- (flat_flat);
  \draw [arrow] (dist_raw) -- (dist_dist);
  \draw [arrow] (chop_raw) -- (chop_chopstd);
  \draw [arrow] (chop_chopstd) -- (chop_chopsci);
  \draw [arrow] (std_chopstd) -- (std_cal);
  \draw [arrow] (cal_chopsci) -- (cal_rest);
  \draw [arrow] (rest_rest) -- (rest_prod);

  %% Horizontal connections
  \draw [match] (lin_lin) -- (chop_lin);
  \draw [match] (pers_pers) -- (chop_pers);
  \draw [match] (dark_dark) -- (flat_dark);
  \draw [match, dashed] (flat_flat) -- (chop_flat);
  \draw [match] (dist_dist) -- (cal_dist);
  \draw [match] (dark_std) -- (std_std);
  \draw [match] (chop_chopstd) -- (std_chopstd);
  \draw [match] (chop_chopsci) -- (cal_chopsci);
  \draw [match] (std_cal) -- (cal_cal);
  \draw [match] (cal_rest) -- (rest_rest);

  %% Legend
  \matrix (legend) [draw, fill=gray!15, above right, row sep=0.3cm,
    column 1/.style={anchor=base},
    column 2/.style={anchor=base west}]
    at ([xshift=-4em,yshift=40ex]current bounding box.south west){%
      \node (leg_recipe) [recipe] {n\_img\_flat};
      & \node {recipe}; \\
      \node (leg_calproduct) [calibproduct] {MASTER\_DARK\_GEO};
      & \node {calib.\ product}; \\
      \node (leg_sciproduct)[scienceproduct] {N\_SCI\_REDUCED};
      & \node {science product}; \\
      \node (leg_qcproduct)[qcproduct]{MASTER\_DARK\_GEO};
      & \node {QC product}; \\
      \node (leg_statcalfile)[statcalfile] {MASTER\_RSRF};
      & \node {static calib.\ file};\\
      \node (leg_calfile)[extcalfile]{FLUXSTD\_CATALOG};
      & \node {external calib.\ file}; \\

    \draw [arrow,fill=black] (0,0.4) -- (0,-0.3);  %% should be centred relative to column
    & \node {processing step}; \\

    \draw (-1, 0.5ex) -- (1,0.5ex) node [connection,yshift=0cm]{};
    & \node {product match}; \\
  };    %% end matrix (legend)

\end{tikzpicture}
