% % Document preamble. Comment out for final figure! Footer too!
% \documentclass[tikz, margin=5mm, dvipsnames]{standalone}
% \usepackage{hyperref}
% \usepackage{listings}
% \input{black_style}
% \input{styles_data}
% \begin{document}


\input{black_style}
\input{recipe_config}

\begin{tikzpicture}
  [x=1cm,
  y=-1cm,
  align=center,
  node distance=2cm and 3cm]
  \sffamily

  %% Grid for orientation. Comment out for final figure!
  % \draw[help lines, green](-5, 0) grid (8, 11);

  %%% Put workflow commands here:
  %% Main reduction workflow

%  \node (template) [template]{%
%    METIS\_img\_lm\_cal\_distortion};

  \pic (start) {start};

  \node (input) [below=0.75cm of start-m, input] {%
    \hyperref[dataitem:lm_distortion_raw]{\RAW{LM_DISTORTION_RAW}}
  };

  \node (step_subtract) [below=2.5cm of input, redstep]{%
    subtract WCU OFF dark
  };

  \node (step_locate) [below=2.5cm of step_subtract, redstep]{%
    locate images};

  \node (step_fit) [below=1.5cm of step_locate, redstep]{%
    fit polynomial};

  \pic (stop) [below=3cm of step_fit]{stop};

  %% Input
  \node (connect_wcuoff) [connection] at
  ($(input)!0.65!(step_subtract)$) {};
  \node (wcuoff) [left=of connect_wcuoff, input] {\hyperref[dataitem:lm_wcu_off_raw]{\RAW{LM_WCU_OFF_RAW}}};
  \draw (wcuoff) -- (connect_wcuoff);

  \node (connect_bpmin) [connection] at
  ($(step_subtract)!0.3!(step_locate)$) {};
  \node (bpmin) [left=of connect_bpmin, calproduct] {\hyperref[dataitem:badpix_map_2rg]{\STATCALIB{BADPIX_MAP_2RG}}};
  \draw (bpmin) -- (connect_bpmin);

  \node (connect_pinhole) [connection] at
  ($(step_subtract)!0.7!(step_locate)$) {};
  \node (pinhole) [left=of connect_pinhole, external] {\hyperref[dataitem:pinhole_table]{\EXTCALIB{PINHOLE_TABLE}}};
  \draw (pinhole) -- (connect_pinhole);

  %% Connections
  \draw (start-m) -- (input);
  \draw (input) -- (step_subtract);
  \draw (step_subtract) -- (step_locate);
  \draw (step_locate) -- (step_fit);
  \draw (step_fit) -- (stop-t);

  %% Output
  \node (connectdisttable) [connection] at
  ($(step_fit)!0.25!(stop-t)$) {};
  \node (disttable) [right=of connectdisttable, calproduct, minimum width=4cm]{%
    \hyperref[dataitem:lm_distortion_table]{\STATCALIB{LM_DISTORTION_TABLE}}};
  \draw (connectdisttable) -- (disttable);

  \node (connectdistmap) [connection] at
  ($(step_fit)!0.5!(stop-t)$) {};
  \node (distmap) [right=of connectdistmap, calproduct, minimum width=4cm]{%
    \hyperref[dataitem:lm_distortion_map]{\STATCALIB{LM_DISTORTION_MAP}}};
  \draw (connectdistmap) -- (distmap);

  \node (connectdistreduced) [connection] at
  ($(step_fit)!0.75!(stop-t)$) {};
  \node (distreduced) [right=of connectdistreduced, calproduct, minimum width=4cm]{%
    \hyperref[dataitem:lm_dist_reduced]{\PROD{LM_DIST_REDUCED}}};
  \draw (connectdistreduced) -- (distreduced);

  %% Frame around recipe
  \draw [frame]
  ($(input)!0.25!(step_subtract) - (2.75,0)$) rectangle
  ($(step_fit)!0.85!(stop-t) + (2.5,0)$);
  \node [framecolor, anchor=north west] at
  ($(input)!0.25!(step_subtract) - (2.75, 0)$){%
    \textsl{metis\_lm\_img\_distortion}};

\end{tikzpicture}
\input{normal_style}


% % Document footer. Comment out for final figure! Header too!
% \end{document}
