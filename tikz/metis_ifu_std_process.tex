\input{recipe_config}

\begin{tikzpicture}
  [x=1cm,
  y=-1cm,
  align=center,
  node distance=2cm and 3cm]
  \sffamily

  %% Grid for orientation. Comment out for final figure!
  %\draw[help lines, green](-5, 0) grid (8, 21);

  %%% Put workflow commands here:
  %% Main reduction workflow

  \node (template) [template]{%
    METIS\_ifu\_cal\_standard
  };

  \pic (start) [below=0.75cm of template] {start};

  \node (input) [below=0.75cm of start-m, input]{%
    \textsl{N} IFU\_STD\_RAW
  };

  \node (step1) [below=2cm of input, redstep]{%
    detector signature\\
    removal
  };

  \node (step2)[below=1.cm of step1, redstep]{%
    background\\
    subtraction
  };

  \node (step3) [below=1.cm of step2, redstep]{%
    rectification
  };

  \node (step4) [below=1.cm of step3, redstep]{%
    1D extraction
  };

  \node (step5) [below=1.cm of step4, redstep]{%
    telluric correction
  };

  \node (step6) [below=1.cm of step5, redstep]{%
    flux calibration
  };

  \pic (stop) [below=2.5cm of step6]{stop};

  %% Connections
  \draw (template) -- (input);
  \draw (input) -- (step1);
  \draw (step1) -- (step2);
  \draw (step2) -- (step3);
  \draw (step3) -- (step4);
  \draw (step4) -- (step5);
  \draw (step5) -- (step6);
  \draw (step6) -- (stop-t);

  %% Input
  \node (connectpers) [connection] at
  ($(input)!0.35!(step1)$) {};
  \node (persistence) [left=3.95cm of connectpers, external]{%
    PERSISTENCE\_MAP
  };
  \draw (persistence) -- (connectpers);

  % Input for detector signature removal (step1)
  \node (bpmin) [left=2cm of step1, yshift=0.8cm, calproduct]{%
    BADPIX\_MAP\_IFU
  };
  \draw (bpmin.east) -- ++(1., 0) -- ++(0., 0.6) -- ++(1., 0);

  \node (darkin) [left=2cm of step1, calproduct] {%
    MASTER\_DARK\_IFU
  };
  \draw (darkin) -- (step1);

  \node (flatin) [left=2cm of step1, yshift=-0.8cm, calproduct]{%
    MASTER\_FLAT\_IFU
  };
  \draw (flatin.east) -- ++(1., 0) -- ++(0., -0.6) -- ++(1., 0);

  % Input for rectification (step3)
  \node (wavecal) [left=2cm of step3, yshift=0.4cm, calproduct]{%
    IFU\_WAVECAL
  };
  \draw (wavecal.east) -- ++(1., 0) -- ++(0., 0.3) -- ++(1., 0);

  \node (distortion) [left=2cm of step3, yshift=-0.4cm, calproduct]{%
    IFU\_DISTORT\_TAB
  };
  \draw (distortion.east) -- ++(1., 0) -- ++(0., -0.3) -- ++(1., 0);

  % Further input
  \node (molecparams) [left=2cm of step5, params]{%
    molecfit parameters
  };
  \draw (molecparams) -- (step5);

  \node (stdcat) [left=2cm of step6, external] {%
    FLUXSTD\_CATALOG
  };
  \draw (stdcat.east) -- (step6);

  %% Output
  \node (connectreduced) [connection] at
  ($(step6)!0.25!(stop-t)$) {};
  \node (reduced) [right=of connectreduced, calproduct]{%
    IFU\_STD\_REDUCED
  };
  \draw (connectreduced) -- (reduced);

  \node (connectfluxcal) [connection] at
  ($(step6)!0.6!(stop-t)$) {};
  \node (fluxcal) [right=of connectfluxcal, calproduct]{%
    FLUXCAL\_TAB
  };
  \draw (connectfluxcal) -- (fluxcal);

  %% Frame around recipe
  \draw [frame] ($(input)!0.5!(step1) - (3.5,0)$)
  rectangle ($(step6)!0.75!(stop-t) + (2.5,0)$);
  \node [framecolor, anchor=north west] at
  ($(input)!0.5!(step1) - (3.5, 0)$) {%
    \textsl{metis\_ifu\_std\_process}};

\end{tikzpicture}
