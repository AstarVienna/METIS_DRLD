%%%%%%%%%%%%%%%%%% BEGIN DOCUMENT %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\sffamily

%%% Picture: flow chart
\begin{tikzpicture}[on grid=false, node distance=0.8cm]

  \matrix (recipes) [column sep=1mm, row sep=1cm]{

    % Row *_raw

    \node[above] (REClin_raw){\recipebox{\NEWRAW{LINEARITY_IFU}}{\NEWREC{metis_det_lingain}}}; &
% TODO: Put back in once we actually include the persistence recipe in the DRLD
%    \node[above] (RECpers_raw){\recipebox{\NEWRAW{PERSISTENCE}}{\NEWREC{metis_det_persistence}}}; &
    \node[above] (RECpers_raw)[empty]{}; &
    \node[above] (RECgeom_raw){\recipebox{\NEWRAW{IFU_DISTORTION_RAW}}{\NEWREC{metis_ifu_distortion}}}; &
    \node[above] (RECrsrf_raw){\recipebox{\NEWRAW{IFU_RSRF_RAW}}{\NEWREC{metis_ifu_rsrf}}}; &
    \node[above] (RECdark_raw){\recipebox{\NEWRAW{DARK_IFU_RAW}}{\NEWREC{metis_det_dark}}}; &
    \node[above] (RECwcal_raw){\recipebox{\NEWRAW{IFU_WAVE_RAW}}{\NEWREC{metis_ifu_wavecal}}}; &
    \node[above] (RECstdreduce_raw){\recipebox{\NEWRAW{IFU_STD_RAW}}{\NEWREC*{metis_ifu_reduce}}}; &
    \node[above] (RECscireduce_raw){\recipebox{\NEWRAW{IFU_SCI_RAW}}{\NEWREC*{metis_ifu_reduce}}}; &
%      \recipebox{\NEWRAW{IFU_STD_RAW}}}{\NEWREC{metis_ifu_std_process}}}
%      \recipenotitlebox{\NEWREC{metis_ifu_std_process}}}
%      so actually this is now just the same as tellcorr
    \node[above] (RECstd_raw){\recipenotitlebox{\NEWREC{metis_ifu_tellcorr}}}; &
    \node[above] (RECtac_raw){\recipenotitlebox{\NEWREC{metis_ifu_tellcorr}}}; &
%      \recipebox{\NEWRAW{IFU_SCI_RAW}}}{\NEWREC{metis_ifu_sci_process}}}
%      \recipenotitlebox{\NEWREC{metis_ifu_sci_process}}}
    \node[above] (RECsci1_raw){\recipenotitlebox{\NEWREC*{metis_ifu_sci_calibrate}}}; &
    \node[above] (RECsci2_raw){\recipenotitlebox{\NEWREC{metis_ifu_sci_postprocess}}}; \\
%    &
%    \node[above] (adi_raw){%
%      \recipenotitlebox{\NEWREC{metis_ifu_adi_cgrph}}}
%    };
    \node (REClin_DIlin)[statcalfile]{\NEWSTATCALIB{LINEARITY_IFU}}; &
    \node (RECpers_DIlin)[empty]{}; &
    \node (RECgeom_DIlin)[empty]{}; &
    \node (RECrsrf_DIlin)[empty]{}; &
    \node (RECdark_DIlin)[empty]{}; &
    \node (RECwcal_DIlin)[empty]{}; &
    \node (RECstdreduce_DIlin)[connection]{}; &
    \node (RECscireduce_DIlin)[connection]{}; &
    \node (RECtac_DIlin)[empty]{}; &
    \node (RECstd_DIlin)[empty]{}; &
    \node (RECsci1_DIlin)[empty]{}; &
    \node (RECsci2_DIlin)[empty]{}; \\

    \node (REClin_DIpers)[empty]{}; &
    \node (RECpers_DIpers)[extcalfile]{\NEWSTATCALIB{PERSISTENCE_MAP}}; &
    \node (RECgeom_DIpers)[empty]{}; &
    \node (RECrsrf_DIpers)[empty]{}; &
    \node (RECdark_DIpers)[empty]{}; &
    \node (RECwcal_DIpers)[empty]{}; &
    \node (RECstdreduce_DIpers)[connection]{}; &
    \node (RECscireduce_DIpers)[connection]{}; &
    \node (RECtac_DIpers)[empty]{}; &
    \node (RECstd_DIpers)[empty]{}; &
    \node (RECsci1_DIpers)[empty]{}; &
    \node (RECsci2_DIpers)[empty]{}; \\

    % Row *_dark
    \node (REClin_DIdark)[empty]{}; &
    \node (RECpers_DIdark)[empty]{}; &
    \node (RECgeom_DIdark)[empty]{}; &
    \node (RECrsrf_DIdark)[empty]{}; &
    \node (RECdark_DIdark)[calibproduct]{\NEWPROD{MASTER_DARK_IFU}}; &
    \node (RECwcal_DIdark)[connection]{}; &
    \node (RECstdreduce_DIdark)[connection]{}; &
    \node (RECscireduce_DIdark)[connection]{}; &
    \node (RECtac_DIdark)[empty]{}; &
    \node (RECstd_DIdark)[empty]{}; &
    \node (RECsci1_DIdark)[empty]{}; &
    \node (RECsci2_DIdark)[empty]{}; \\
%    &
%    \node (adi_DIdark)[empty]{};

    % Row *_geom
    \node (REClin_DIgeom)[empty]{}; &
    \node (RECpers_DIgeom)[empty]{}; &
    \node (RECgeom_DIgeom)[statcalfile]{\NEWPROD{IFU_DISTORTION_TABLE}}; &
    \node (RECrsrf_DIgeom)[connection]{}; &
    \node (RECdark_DIgeom)[empty]{}; &
    \node (RECwcal_DIgeom)[connection]{}; &
    \node (RECstdreduce_DIgeom)[connection]{}; &
    \node (RECscireduce_DIgeom)[connection]{}; &
    \node (RECstd_DIgeom)[empty]{}; &
    \node (RECtac_DIgeom)[empty]{}; &
    \node (RECsci1_DIgeom)[empty]{}; &
    \node (RECsci2_DIgeom)[empty]{}; \\
%    &
%    \node (adi_DIgeom)[empty]{};

    % Row *_rsrf
    \node (REClin_DIrsrf)[empty]{}; &
    \node (RECpers_DIrsrf)[empty]{}; &
    \node (RECgeom_DIrsrf)[empty]{}; &
    \node (RECrsrf_DIrsrf)[statcalfile]{\NEWPROD{RSRF_IFU}}; &
    \node (RECdark_DIrsrf)[empty]{}; &
    \node (RECwcal_DIrsrf)[empty]{}; &
    \node (RECstdreduce_DIrsrf)[connection]{}; &
    \node (RECscireduce_DIrsrf)[connection]{}; &
    \node (RECstd_DIrsrf)[empty]{}; &
    \node (RECtac_DIrsrf)[empty]{}; &
    \node (RECsci1_DIrsrf)[empty]{}; &
    \node (RECsci2_DIrsrf)[empty]{}; \\
%    &
%    \node (adi_DIrsrf)[empty]{};

    % Row *_wcal
    \node (REClin_DIwcal)[empty]{}; &
    \node (RECpers_DIwcal)[empty]{}; &
    \node (RECgeom_DIwcal)[empty]{}; &
    \node (RECrsrf_DIwcal)[empty]{}; &
    \node (RECdark_DIwcal)[empty]{}; &
    \node (RECwcal_DIwcal) [calibproduct]{\NEWPROD{IFU_WAVECAL}}; &
    \node (RECstdreduce_DIwcal)[connection]{}; &
    \node (RECscireduce_DIwcal)[connection]{}; &
    \node (RECstd_DIwcal)[empty]{}; &
    \node (RECsci1_DIwcal)[empty]{}; &
    \node (RECtac_DIwcal)[empty]{}; &
    \node (RECsci2_DIwcal)[empty]{}; \\
%    \node (adi_DIwcal)[empty]{};

    % Row *_scireduced
    \node (REClin_DIscireduced)[empty]{}; &
    \node (RECpers_DIscireduced)[empty]{}; &
    \node (RECgeom_DIscireduced)[empty]{}; &
    \node (RECrsrf_DIscireduced)[empty]{}; &
    \node (RECdark_DIstdreduced)[empty]{}; &
    \node (RECwcal_DIscireduced)[empty]{}; &
    \node (RECstdreduce_DIscireduced)[empty]{}; &
    \node (RECscireduce_DIscireduced)[scienceproduct]{\NEWEXTCALIB{IFU_SCI_REDUCED}};
    \node (RECscireduce_DIscibackground)[scienceproduct,below=0.5cm]{\NEWEXTCALIB{IFU_SCI_BACKGROUND}};
    \node (RECscireduce_DIscireducedcube)[scienceproduct,below=1.25cm]{\NEWEXTCALIB{IFU_SCI_REDUCED_CUBE}};
    \node (RECscireduce_DIsciobject1d)[scienceproduct,below=2.0cm]{\NEWEXTCALIB{IFU_SCI_OBJECT_1D}};
    \draw [-] (RECscireduce_DIscireduced) -- (RECscireduce_DIscibackground) -- (RECscireduce_DIscireducedcube) -- (RECscireduce_DIsciobject1d); &
    \node (RECstd_DIscireduced)[empty]{}; &
    \node (RECtac_DIscireduced)[empty]{}; &
    \node (RECsci1_DIscireduced)[empty]{}; &
    \node (RECsci2_DIscireduced)[empty]{}; \\
%    \node (adi_DIscireduced)[empty]{};

    % Row *_stdreduced
    \node (REClin_DIstdreduced)[empty]{}; &
    \node (RECpers_DIstdreduced)[empty]{}; &
    \node (RECgeom_DIstdreduced)[empty]{}; &
    \node (RECrsrf_DIstdreduced)[empty]{}; &
    \node (RECdark_DIstdreduced)[empty]{}; &
    \node (RECwcal_DIstdreduced)[empty]{}; &
    \node (RECstdreduce_DIstdreduced)[scienceproduct]{\NEWPROD*{IFU_STD_REDUCED}};
    \node (RECstdreduce_DIstdbackground)[scienceproduct,below=0.5cm]{\NEWPROD*{IFU_STD_BACKGROUND}};
    \node (RECstdreduce_DIstdobject1d)[scienceproduct,below=1.25cm]{\NEWPROD*{IFU_STD_OBJECT_1D}};
    \draw [-] (RECstdreduce_DIstdreduced) -- (RECstdreduce_DIstdbackground) -- (RECstdreduce_DIstdobject1d); &
    \node (RECscireduce_DIstdreduced)[empty]{}; &
    \node (RECstd_DIstdreduced)[empty]{}; &
    \node (RECtac_DIstdreduced)[empty]{}; &
    \node (RECsci1_DIstdreduced)[empty]{}; &
    \node (RECsci2_DIstdreduced)[empty]{}; \\
    %    &
%    \node (adi_DIstdreduced)[empty]{};

    % Row *_basicstd
    \node (REClin_DIfluxstd)[empty]{}; &
    \node (RECpers_DIfluxstd)[empty]{}; &
    \node (RECgeom_DIfluxstd)[empty]{}; &
    \node (RECrsrf_DIfluxstd)[empty]{}; &
    \node (RECdark_DIfluxstd)[extcalfile]{\NEWEXTCALIB{FLUXSTD_CATALOG}}; &
    \node (RECwcal_DIfluxstd)[empty]{}; &
    \node (RECstdreduce_DIfluxstd)[empty]{}; &
    \node (RECscireduce_DIfluxstd)[empty]{}; &
    \node (RECstd_DIfluxstd)[connection]{}; &
    \node (RECtac_DIfluxstd)[empty]{}; &
    \node (RECsci1_DIfluxstd)[empty]{}; &
    \node (RECsci2_DIfluxstd)[empty]{}; \\
%    &
%    \node (adi_DIfluxstd)[empty]{};

    % Row *_tac
    \node (REClin_DItac)[empty]{}; &
    \node (RECpers_DItac)[empty]{}; &
    \node (RECgeom_DItac)[empty]{}; &
    \node (RECrsrf_DItac)[empty]{}; &
    \node (RECdark_DItac)[empty]{}; &
    \node (RECwcal_DItac)[empty]{}; &
    \node (RECstdreduce_DItac)[empty]{}; &
    \node (RECscireduce_DItac)[empty]{}; &
    \node (RECstd_DItac)[empty]{}; &
    \node (RECtac_DItac)[calibproduct]{\NEWPROD*{IFU_TELLURIC}}; &
    \node (RECsci1_DItac)[connection]{}; &
    \node (RECsci2_DItac)[empty]{}; \\
%    &
%    \node (adi_DItac)[empty]{};

    % Row *_fcal
    \node (REClin_DIfcal)[empty]{}; &
    \node (RECpers_DIfcal)[empty]{}; &
    \node (RECgeom_DIfcal)[empty]{}; &
    \node (RECrsrf_DIfcal)[empty]{}; &
    \node (RECdark_DIfcal)[empty]{}; &
    \node (RECwcal_DIfcal)[empty]{}; &
    \node (RECstdreduce_DIfcal)[empty]{}; &
    \node (RECscireduce_DIfcal)[empty]{}; &
    \node (RECstd_DIfcal)[calibproduct]{\NEWPROD{FLUXCAL_TAB}};
    \node (RECstd_DItelluricstd)[calibproduct,below=.5cm]{\NEWPROD*{IFU_TELLURIC}};
    \draw [-] (RECstd_DIfcal) -- (RECstd_DItelluricstd); &
    \node (RECtac_DIfcal)[empty]{}; &
    \node (RECsci1_DIfcal)[connection]{};
    % No clue how to get this .70 nicely done
    \node (RECsci1_DItelluricstd)[connection,below=.70cm]{}; &
    \node (RECsci2_DIfcal)[empty]{}; \\
%    &
%    \node (adi_DIfcal)[empty]{};

    % Row *_sci1
    \node (REClin_DIsci1)[empty]{}; &
    \node (RECpers_DIsci1)[empty]{}; &
    \node (RECgeom_DIsci1)[empty]{}; &
    \node (RECrsrf_DIsci1)[empty]{}; &
    \node (RECdark_DIsci1)[empty]{}; &
    \node (RECwcal_DIsci1)[empty]{}; &
    \node (RECstdreduce_DIsci1)[empty]{}; &
    \node (RECscireduce_DIsci1)[empty]{}; &
    \node (RECstd_DIsci1)[empty]{}; &
%    \node (RECtac_DIsci1)[scienceproduct]{\NEWPROD{IFU_SCI_CALIBRATED_TAC}}};
    \node (RECtac_DIsci1)[empty]{}; &
    \node (RECsci1_DIsci1)[scienceproduct]{\NEWPROD*{IFU_SCI_CUBE_CALIBRATED}}; &
    \node (RECsci2_DIsci1)[connection]{}; \\
%    &
%    \node (adi_DIsci1)[empty]{};

    % Row *_sci2
    \node (REClin_DIsci2)[empty]{}; &
    \node (RECpers_DIsci2)[empty]{}; &
    \node (RECgeom_DIsci2)[empty]{}; &
    \node (RECrsrf_DIsci2)[empty]{}; &
    \node (RECdark_DIsci2)[empty]{}; &
    \node (RECwcal_DIsci2)[empty]{}; &
    \node (RECstdreduce_DIsci2)[empty]{}; &
    \node (RECscireduce_DIsci2)[empty]{}; &
    \node (RECstd_DIsci2)[empty]{}; &
%    \node (RECtac_DIsci2)[scienceproduct]{\NEWPROD{IFU_SCI_COMBINED_TAC}}};
    \node (RECtac_DIsci2)[empty]{}; &
%    \node (RECsci1_DIsci2)[scienceproduct]{\NEWPROD{IFU_SCI_COMBINED}}};
    \node (RECsci1_DIsci2)[empty]{}; &
    \node (RECsci2_DIsci2) [empty]{}; \\
%    &
%    \node (adi_DIsci2) [connection]{};

    % Row *_adi
    \node (REClin_adi)[empty]{}; &
    \node (RECpers_adi)[empty]{}; &
    \node (RECgeom_adi)[empty]{}; &
    \node (RECrsrf_adi)[empty]{}; &
    \node (RECdark_adi)[empty]{}; &
    \node (RECwcal_adi)[empty]{}; &
    \node (RECstdreduce_adi)[empty]{}; &
    \node (RECscireduce_adi)[empty]{}; &
    \node (RECstd_adi)[empty]{}; &
    \node (RECtac_adi)[empty]{}; &
    \node (RECsci1_adi)[empty]{}; &
    \node (RECsci2_adi)[scienceproduct]{\NEWPROD{IFU_SCI_COADD}}; \\
%    &
%    \node (adi_adi)[scienceproduct]{ADI\_SCI\_COADD};
  };    % end matrix


  % dashed line separating daily procedure
  \node (t1) at ($(RECrsrf_raw)!0.5!(RECdark_raw)$){};
  \node (t2) at ($(RECrsrf_adi)!0.5!(RECdark_adi)$){} ;
  \draw [thick,dashed] ([yshift=4ex]t1.north) -- ([yshift=-0ex]t2.south);


  %% Connections
  \draw [arrow] (REClin_raw) -- (REClin_DIlin);
% TODO: Put back in once we actually include the persistence recipe in the DRLD
%  \draw [arrow] (RECpers_raw) -- (RECpers_DIpers);
  \draw [arrow] (RECgeom_raw) -- (RECgeom_DIgeom);
  \draw [arrow] (RECrsrf_raw) -- (RECrsrf_DIrsrf);
  \draw [arrow] (RECwcal_raw) -- (RECwcal_DIwcal);
  \draw [arrow] (RECdark_raw) -- (RECdark_DIdark);
  \draw [arrow] (RECscireduce_raw)  -- (RECscireduce_DIscireduced);
  \draw [arrow] (RECstdreduce_raw)  -- (RECstdreduce_DIstdreduced);

  \draw [match] (REClin_DIlin) --
% TODO: Put back in once we actually include the persistence recipe in the DRLD
%        (RECpers_DIlin) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECgeom_DIlin) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECrsrf_DIlin) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECdark_DIlin) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECwcal_DIlin) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECscireduce_DIlin);
  \draw [match] (RECpers_DIpers) -- 
        (RECgeom_DIpers) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECrsrf_DIpers) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECdark_DIpers) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECwcal_DIpers) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] --
        (RECscireduce_DIpers);
  \draw [match] (RECdark_DIdark) -- (RECscireduce_DIdark);

  \draw [match] (RECrsrf_DIrsrf) -- (RECwcal_DIrsrf) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] -- (RECscireduce_DIrsrf);

  \draw [match] (RECwcal_DIwcal)  -- (RECscireduce_DIwcal);
  \draw [match] (RECgeom_DIgeom)  -- (RECscireduce_DIgeom);
  \draw [match] (RECdark_DIfluxstd)   -- (RECstd_DIfluxstd);   % Line from FLUXSTD_CATALOG to further
  \draw [match] (RECstd_DIfcal)  -- (RECsci1_DIfcal);
  \draw [match,dashed] (RECstd_DItelluricstd)  -- (RECsci1_DItelluricstd);
  \draw [match] (RECtac_DItac)  -- (RECsci1_DItac);

% -| means first horizontal, then vertical
  \draw [arrow] (RECstdreduce_DIstdobject1d) -| (RECstd_DIfcal);
  \draw [arrow] (RECscireduce_DIscireducedcube) -| (RECtac_DItac);
  \draw [arrow] (RECscireduce_DIscireduced) -| (RECsci1_DIsci1);
  \draw [arrow] (RECsci1_DIsci1) -| (RECsci2_adi);



  %\draw [very thick,dashed] ($(raw_geometry.north)!0.5!(raw_dark.north)$) -- ++(270:15cm);

  %% Legend
  \matrix (legend) [draw, fill=gray!15, above right, row sep=0.3cm,
    column 1/.style={anchor=base},
    column 2/.style={anchor=base west}]
  at ([yshift=0cm]current bounding box.south west){%
    \node (leg_recipe) [recipe]{ifu\_sci\_process};
    & \node {recipe}; \\
    \node (leg_calproduct) [calibproduct]{MASTER\_DARK};
    & \node{calib.\ product}; \\
    \node (leg_sciproduct)[scienceproduct]{SCI\_REDUCED};
    & \node {science product}; \\
    \node (leg_statcalfile)[statcalfile]{MASTER\_RSRF};
    & \node {static calib.\ file};\\
    \node (leg_calfile)[extcalfile]{FLUXSTD\_CATALOG};
    & \node {external file}; \\

    \draw [arrow,fill=black] (0,0.4) -- (0,-0.3);  %% should be centred relative to column
    & \node {processing step}; \\

    \draw (-1, 0.5ex) -- (1,0.5ex) node [connection,yshift=0cm]{};
    & \node {product match}; \\
  };    %% end matrix (legend)

\end{tikzpicture}
