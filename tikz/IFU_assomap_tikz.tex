%%%%%%%%%%%%%%%%%% BEGIN DOCUMENT %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\sffamily

%%% Picture: flow chart
\begin{tikzpicture}[on grid=false, node distance=0.8cm]

  \matrix (recipes) [column sep=1mm, row sep=1cm]{

    % Row *_raw

    \node[above] (RECgeom_raw){%
      \recipebox{\hyperref[dataitem:ifu_distortion_raw]{\RAW{IFU_DISTORTION_RAW}}}{\hyperref[rec:metis_ifu_distortion]{\REC{metis_ifu_distortion}}}
    };
    &
    \node[above] (RECrsrf_raw){%
      \recipebox{\hyperref[dataitem:ifu_rsrf_raw]{\RAW{IFU_RSRF_RAW}}}{\hyperref[rec:metis_ifu_rsrf]{\REC{metis_ifu_rsrf}}}
    };
    &
    \node[above] (RECdark_raw) {%
      \recipebox{\hyperref[dataitem:dark_ifu_raw]{\RAW{DARK_IFU_RAW}}}{\hyperref[rec:metis_det_dark]{\REC{metis_det_dark}}}
    };
    &
    \node[above] (RECwcal_raw){%
      \recipebox{\hyperref[dataitem:ifu_wave_raw]{\RAW{IFU_WAVE_RAW}}}{\hyperref[rec:metis_ifu_wavecal]{\REC{metis_ifu_wavecal}}}
    };
    &
    \node[above] (RECstdreduce_raw){%
      \recipebox{\hyperref[dataitem:ifu_std_raw]{\RAW{IFU_STD_RAW}}}{\REC{metis_ifu_reduce}}
    };
    &
    \node[above] (RECscireduce_raw){%
      \recipebox{\hyperref[dataitem:ifu_sci_raw]{\RAW{IFU_SCI_RAW}}}{\REC{metis_ifu_reduce}}
    };
    &
    \node[above] (RECstd_raw){%
%      \recipebox{\hyperref[dataitem:ifu_std_raw]{\RAW{IFU_STD_RAW}}}{\hyperref[rec:metis_ifu_std_process]{\REC{metis_ifu_std_process}}}
%      \recipenotitlebox{\hyperref[rec:metis_ifu_std_process]{\REC{metis_ifu_std_process}}}
%      so actually this is now just the same as tellcorr
      \recipenotitlebox{\hyperref[rec:metis_ifu_tellcorr]{\REC{metis_ifu_tellcorr}}}
    };
    &
    \node[above] (RECtac_raw){%
      \recipenotitlebox{\hyperref[rec:metis_ifu_tellcorr]{\REC{metis_ifu_tellcorr}}}
    };
    &
    \node[above] (RECsci1_raw) {%
%      \recipebox{\hyperref[dataitem:ifu_sci_raw]{\RAW{IFU_SCI_RAW}}}{\hyperref[rec:metis_ifu_sci_process]{\REC{metis_ifu_sci_process}}}
%      \recipenotitlebox{\hyperref[rec:metis_ifu_sci_process]{\REC{metis_ifu_sci_process}}}
      \recipenotitlebox{\REC{metis_ifu_sci_calibrate}}
    };
    &
    \node[above] (RECsci2_raw){%
      \recipenotitlebox{\hyperref[rec:metis_ifu_sci_postprocess]{\REC{metis_ifu_sci_postprocess}}}
    };
%    &
%    \node[above] (adi_raw){%
%      \recipenotitlebox{\hyperref[rec:metis_ifu_adi_cgrph]{\REC{metis_ifu_adi_cgrph}}}
%    };
    \\

    % Row *_dark
    \node (RECgeom_DIdark)[empty]{};
    &
    \node (RECrsrf_DIdark)[empty]{};
    &
    \node (RECdark_DIdark) [calibproduct] {\hyperref[dataitem:master_dark_ifu]{\PROD{MASTER_DARK_IFU}}};
    &
    \node (RECwcal_DIdark)[connection]{};
    &
    \node (RECstdreduce_DIdark)[connection]{};
    &
    \node (RECscireduce_DIdark)[connection]{};
    &
    \node (RECtac_DIdark) [empty]{};
    &
    \node (RECstd_DIdark)[empty]{};
    &
    \node (RECsci1_DIdark)[empty]{};
    &
    \node (RECsci2_DIdark)[empty]{};
%    &
%    \node (adi_DIdark)[empty]{};
    \\

    % Row *_geom
    \node (RECgeom_DIgeom) [statcalfile] {\hyperref[dataitem:ifu_distortion_table]{\PROD{IFU_DISTORTION_TABLE}}};
    &
    \node (RECrsrf_DIgeom)[connection]{};
    &
    \node (RECdark_DIgeom)[empty]{};
    &
    \node (RECwcal_DIgeom)[connection]{};
    &
    \node (RECstdreduce_DIgeom)[connection]{};
    &
    \node (RECscireduce_DIgeom)[connection]{};
    &
    \node (RECstd_DIgeom)[empty]{};
    &
    \node (RECtac_DIgeom)[empty]{};
    &
    \node (RECsci1_DIgeom)[empty]{};
    &
    \node (RECsci2_DIgeom)[empty]{};
%    &
%    \node (adi_DIgeom)[empty]{};
    \\

    % Row *_rsrf
    \node (RECgeom_DIrsrf) [empty]{};
    &
    \node (RECrsrf_DIrsrf) [statcalfile] {\hyperref[dataitem:rsrf_ifu]{\PROD{RSRF_IFU}}};
    &
    \node (RECdark_DIrsrf)[empty]{};
    &
    \node (RECwcal_DIrsrf)[empty]{};
    &
    \node (RECstdreduce_DIrsrf)[connection]{};
    &
    \node (RECscireduce_DIrsrf)[connection]{};
    &
    \node (RECstd_DIrsrf)[empty]{};
    &
    \node (RECtac_DIrsrf)[empty]{};
    &
    \node (RECsci1_DIrsrf)[empty]{};
    &
    \node (RECsci2_DIrsrf)[empty]{};
%    &
%    \node (adi_DIrsrf)[empty]{};
    \\



    % Row *_wcal
    \node (RECgeom_DIwcal)[empty]{};
    &
    \node (RECrsrf_DIwcal)[empty]{};
    &
    \node (RECdark_DIwcal)[empty]{};
    &
    \node (RECwcal_DIwcal) [calibproduct] {\hyperref[dataitem:ifu_wavecal]{\PROD{IFU_WAVECAL}}};
    &
    \node (RECstdreduce_DIwcal)[connection]{};
    &
    \node (RECscireduce_DIwcal)[connection]{};
    &
    \node (RECstd_DIwcal)[empty]{};
    &
    \node (RECsci1_DIwcal)[empty]{};
    &
    \node (RECtac_DIwcal)[empty]{};
    &
    \node (RECsci2_DIwcal)[empty]{};
%    &
%    \node (adi_DIwcal)[empty]{};
    \\

    % Row *_scireduced
    \node (RECgeom_DIscireduced)[empty]{};
    &
    \node (RECrsrf_DIscireduced)[empty]{};
    &
    \node (RECdark_DIstdreduced)[empty]{};
    &
    \node (RECwcal_DIscireduced)[empty]{};
    &
    \node (RECstdreduce_DIscireduced)[empty]{};
    &
    \node (RECscireduce_DIscireduced)[scienceproduct] {\hyperref[dataitem:ifu_sci_reduced]{\EXTCALIB{IFU_SCI_REDUCED}}};
    \node (RECscireduce_DIscibackground)[scienceproduct,below=0.5cm] {\hyperref[dataitem:ifu_sci_background]{\EXTCALIB{IFU_SCI_BACKGROUND}}};
    \node (RECscireduce_DIscireducedcube)[scienceproduct,below=1.25cm] {\hyperref[dataitem:ifu_sci_reduced_cube]{\EXTCALIB{IFU_SCI_REDUCED_CUBE}}};
    \node (RECscireduce_DIsciobject1d)[scienceproduct,below=2.0cm] {\hyperref[dataitem:ifu_sci_object_1d]{\EXTCALIB{IFU_SCI_OBJECT_1D}}};
    \draw [-] (RECscireduce_DIscireduced) -- (RECscireduce_DIscibackground) -- (RECscireduce_DIscireducedcube) -- (RECscireduce_DIsciobject1d);
    &
    \node (RECstd_DIscireduced)[empty]{};
    &
    \node (RECtac_DIscireduced)[empty]{};
    &
    \node (RECsci1_DIscireduced)[empty]{};
    &
    \node (RECsci2_DIscireduced)[empty]{};
%    &
%    \node (adi_DIscireduced)[empty]{};
    \\

    % Row *_stdreduced
    \node (RECgeom_DIstdreduced)[empty]{};
    &
    \node (RECrsrf_DIstdreduced)[empty]{};
    &
    \node (RECdark_DIstdreduced)[empty]{};
    &
    \node (RECwcal_DIstdreduced)[empty]{};
    &
    \node (RECstdreduce_DIstdreduced)[scienceproduct] {\PROD{IFU_STD_REDUCED}};
    \node (RECstdreduce_DIstdbackground)[scienceproduct,below=0.5cm] {\PROD{IFU_STD_BACKGROUND}};
    \node (RECstdreduce_DIstdobject1d)[scienceproduct,below=1.25cm] {\PROD{IFU_STD_OBJECT_1D}};
    \draw [-] (RECstdreduce_DIstdreduced) -- (RECstdreduce_DIstdbackground) -- (RECstdreduce_DIstdobject1d);
    &
    \node (RECscireduce_DIstdreduced)[empty]{};
    &
    \node (RECstd_DIstdreduced)[empty]{};
    &
    \node (RECtac_DIstdreduced)[empty]{};
    &
    \node (RECsci1_DIstdreduced)[empty]{};
    &
    \node (RECsci2_DIstdreduced)[empty]{};
%    &
%    \node (adi_DIstdreduced)[empty]{};
    \\

    % Row *_basicstd
    \node (RECgeom_DIfluxstd)[empty]{};
    &
    \node (RECrsrf_DIfluxstd)[empty]{};
    &
    \node (RECdark_DIfluxstd)[extcalfile] {\hyperref[dataitem:fluxstd_catalog]{\EXTCALIB{FLUXSTD_CATALOG}}};
    &
    \node (RECwcal_DIfluxstd)[empty]{};
    &
    \node (RECstdreduce_DIfluxstd)[empty]{};
    &
    \node (RECscireduce_DIfluxstd)[empty]{};
    &
    \node (RECstd_DIfluxstd)[connection]{};
    &
    \node (RECtac_DIfluxstd)[empty]{};
    &
    \node (RECsci1_DIfluxstd)[empty]{};
    &
    \node (RECsci2_DIfluxstd)[empty]{};
%    &
%    \node (adi_DIfluxstd)[empty]{};
    \\

    % Row *_tac
    &
    \node (RECrsrf_DItac)[empty]{};
    &
    \node (RECdark_DItac)[empty]{};
    &
    \node (RECwcal_DItac)[empty]{};
    &
    \node (RECstdreduce_DItac)[empty]{};
    &
    \node (RECscireduce_DItac)[empty]{};
    &
    \node (RECstd_DItac)[empty]{};
    &
    \node (RECtac_DItac)[calibproduct] {\PROD{IFU_TELLURIC}};
    &
    \node (RECsci1_DItac)[connection]{};
    &
    \node (RECsci2_DItac)[empty]{};
%    &
%    \node (adi_DItac)[empty]{};
    \\

    % Row *_fcal
    \node (RECgeom_DIfcal)[empty]{};
    &
    \node (RECrsrf_DIfcal)[empty]{};
    &
    \node (RECdark_DIfcal)[empty]{};
    &
    \node (RECwcal_DIfcal)[empty]{};
    &
    \node (RECstdreduce_DIfcal)[empty]{};
    &
    \node (RECscireduce_DIfcal)[empty]{};
    &
    \node (RECstd_DIfcal)[calibproduct] {\hyperref[dataitem:fluxcal_tab]{\PROD{FLUXCAL_TAB}}};
    \node (RECstd_DItelluricstd)[calibproduct,below=.5cm] {\PROD{IFU_TELLURIC}};
    \draw [-] (RECstd_DIfcal) -- (RECstd_DItelluricstd);
    &
    \node (RECtac_DIfcal)[empty]{};
    &
    \node (RECsci1_DIfcal)[connection]{};
    % No clue how to get this .70 nicely done
    \node (RECsci1_DItelluricstd)[connection,below=.70cm]{};
    &
    \node (RECsci2_DIfcal)[empty]{};
%    &
%    \node (adi_DIfcal)[empty]{};
    \\

    % Row *_sci1
    \node (RECgeom_DIsci1)[empty]{};
    &
    \node (RECrsrf_DIsci1)[empty]{};
    &
    \node (RECdark_DIsci1)[empty]{};
    &
    \node (RECwcal_DIsci1)[empty]{};
    &
    \node (RECstdreduce_DIsci1)[empty]{};
    &
    \node (RECscireduce_DIsci1)[empty]{};
    &
    \node (RECstd_DIsci1)[empty]{};
    &
%    \node (RECtac_DIsci1)[scienceproduct] {\hyperref[dataitem:ifu_sci_calibrated_tac]{\PROD{IFU_SCI_CALIBRATED_TAC}}};
    \node (RECtac_DIsci1)[empty] {};
    &
    \node (RECsci1_DIsci1)[scienceproduct] {\PROD{IFU_SCI_CUBE_CALIBRATED}};
    &
    \node (RECsci2_DIsci1)[connection]{};
%    &
%    \node (adi_DIsci1)[empty]{};
    \\

    % Row *_sci2
    \node (RECgeom_DIsci2)[empty]{};
    &
    \node (RECrsrf_DIsci2)[empty]{};
    &
    \node (RECdark_DIsci2)[empty]{};
    &
    \node (RECwcal_DIsci2)[empty]{};
    &
    \node (RECstdreduce_DIsci2)[empty]{};
    &
    \node (RECscireduce_DIsci2)[empty]{};
    &
    \node (RECstd_DIsci2)[empty]{};
    &
%    \node (RECtac_DIsci2)[scienceproduct] {\hyperref[dataitem:ifu_sci_combined_tac]{\PROD{IFU_SCI_COMBINED_TAC}}};
    \node (RECtac_DIsci2)[empty] {};
    &
%    \node (RECsci1_DIsci2)[scienceproduct] {\hyperref[dataitem:ifu_sci_combined]{\PROD{IFU_SCI_COMBINED}}};
    \node (RECsci1_DIsci2)[empty] {};
    &
    \node (RECsci2_DIsci2) [empty]{};
%    &
%    \node (adi_DIsci2) [connection]{};
    \\

    % Row *_adi
    \node (RECgeom_adi)[empty]{};
    &
    \node (RECrsrf_adi)[empty]{};
    &
    \node (RECdark_adi)[empty]{};
    &
    \node (RECwcal_adi)[empty]{};
    &
    \node (RECstdreduce_adi)[empty]{};
    &
    \node (RECscireduce_adi)[empty]{};
    &
    \node (RECstd_adi)[empty]{};
    &
    \node (RECtac_adi)[empty]{};
    &
    \node (RECsci1_adi)[empty]{};
    &
    \node (RECsci2_adi)[scienceproduct] {\hyperref[dataitem:ifu_sci_coadd]{\PROD{IFU_SCI_COADD}}};
%    &
%    \node (adi_adi)[scienceproduct]{ADI\_SCI\_COADD};
    \\
  };    % end matrix


  % dashed line separating daily procedure
  \node (t1) at ($(RECrsrf_raw)!0.5!(RECdark_raw)$){};
  \node (t2) at ($(RECrsrf_adi)!0.5!(RECdark_adi)$){} ;
  \draw [thick,dashed] ([yshift=4ex]t1.north) -- ([yshift=-0ex]t2.south);


  %% Connections
  \draw [arrow] (RECgeom_raw) -- (RECgeom_DIgeom);
  \draw [arrow] (RECrsrf_raw) -- (RECrsrf_DIrsrf);
  \draw [arrow] (RECwcal_raw) -- (RECwcal_DIwcal);
  \draw [arrow] (RECdark_raw) -- (RECdark_DIdark);
  \draw [arrow] (RECscireduce_raw)  -- (RECscireduce_DIscireduced);
  \draw [arrow] (RECstdreduce_raw)  -- (RECstdreduce_DIstdreduced);

  \draw [match] (RECdark_DIdark) -- (RECscireduce_DIdark);

  \draw [match] (RECrsrf_DIrsrf) -- (RECwcal_DIrsrf) [xshift=-0.15cm] arc [start angle=180, end angle=0, radius=.15cm] -- (RECscireduce_DIrsrf);

  \draw [match] (RECwcal_DIwcal)  -- (RECscireduce_DIwcal);
  \draw [match] (RECgeom_DIgeom)  -- (RECscireduce_DIgeom);
  \draw [match] (RECdark_DIfluxstd)   -- (RECstd_DIfluxstd);   % Line from FLUXSTD_CATALOG to further
  \draw [match] (RECstd_DIfcal)  -- (RECsci1_DIfcal);
  \draw [match,dashed] (RECstd_DItelluricstd)  -- (RECsci1_DItelluricstd);
  \draw [match] (RECtac_DItac)  -- (RECsci1_DItac);

% -| means first horizontal, then vertical
  \draw [arrow] (RECstdreduce_DIstdobject1d) -| (RECstd_DIfcal);
  \draw [arrow] (RECscireduce_DIscireducedcube) -| (RECtac_DItac);
  \draw [arrow] (RECscireduce_DIscireduced) -| (RECsci1_DIsci1);
  \draw [arrow] (RECsci1_DIsci1) -| (RECsci2_adi);



  %\draw [very thick,dashed] ($(raw_geometry.north)!0.5!(raw_dark.north)$) -- ++(270:15cm);

  %% Legend
  \matrix (legend) [draw, fill=gray!15, above right, row sep=0.3cm,
    column 1/.style={anchor=base},
    column 2/.style={anchor=base west}]
  at ([yshift=0cm]current bounding box.south west){%
    \node (leg_recipe) [recipe] {ifu\_sci\_process};
    & \node {recipe}; \\
    \node (leg_calproduct) [calibproduct] {MASTER\_DARK};
    & \node{calib.\ product}; \\
    \node (leg_sciproduct)[scienceproduct] {SCI\_REDUCED};
    & \node {science product}; \\
    \node (leg_statcalfile)[statcalfile] {MASTER\_RSRF};
    & \node {static calib.\ file};\\
    \node (leg_calfile)[extcalfile] {FLUXSTD\_CATALOG};
    & \node {external file}; \\

    \draw [arrow,fill=black] (0,0.4) -- (0,-0.3);  %% should be centred relative to column
    & \node {processing step}; \\

    \draw (-1, 0.5ex) -- (1,0.5ex) node [connection,yshift=0cm]{};
    & \node {product match}; \\
  };    %% end matrix (legend)

\end{tikzpicture}
