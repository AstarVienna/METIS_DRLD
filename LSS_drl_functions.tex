\subsection{LSS observing mode}\label{sec:drl_functions_lss}

%---------------------------------------------------------------------
\subsubsection{Order background correction}\label{drl:correctorder}\label{drl:correct_order_bg}
\begin{recipedef}
Name: & \hyperref[drl:correct_order_bg]{\DRL{correct_order_bg}} \\
Purpose: & Removal of order background contamination (e.g. stray light)\\
Used in recipes: & \hyperref[rec:metis_lm_lss_rsrf]{\REC{metis_LM_lss_rsrf}} \newline
                  \hyperref[rec:metis_n_lss_rsrf]{\REC{metis_N_lss_rsrf}} \newline
                  \hyperref[rec:metis_lm_lss_wave]{\REC{metis_LM_lss_wave}} \newline
                  \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \newline
                  \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \newline
                  \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}}\newline
                  \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Removal of stray light by a 2D-polynomial fits of the order background \\
Mathematical description: & see Section~\ref{ssec:orderbg} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}


%---------------------------------------------------------------------
\subsubsection{Subtract WCU OFF frame from frame}\label{drl:subtractwcuoffillum}\label{drl:subtract_wcu_off_illum}
\begin{recipedef}\label{rec:subtrwcuoffillum}
Name: & \hyperref[drl:subtract_wcu_off_illum]{\DRL{subtract_wcu_off_illum}} \\
Purpose: & Subtract a WCU-OFF frame \\
Used in recipes: & \hyperref[rec:metis_lm_lss_rsrf]{\REC{metis_LM_lss_rsrf}} \\
& \hyperref[rec:metis_n_lss_rsrf]{\REC{metis_N_lss_rsrf}} \\
& \hyperref[rec:metis_lm_adc_slitloss]{\REC{metis_lm_adc_slitloss}} \\
& \hyperref[rec:metis_n_adc_slitloss]{\REC{metis_n_adc_slitloss}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Subtracts a WCU-OFF frame from an WCU image \\
Mathematical description: &  see~\cite{pis02} and~\cite{pis21}\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}
%---------------------------------------------------------------------
\subsubsection{Calculate blackbody spectrum}\label{drl:calcbb}\label{drl:calc_bb}
\begin{recipedef}\label{rec:calcbb}
Name: & \hyperref[drl:calc_bb]{\DRL{calc_bb}} \\
Purpose: & Calculate blackbody spectrum \\
Used in recipes: & \hyperref[rec:metis_lm_lss_rsrf]{\REC{metis_LM_lss_rsrf}} \\
& \hyperref[rec:metis_n_lss_rsrf]{\REC{metis_N_lss_rsrf}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & temperature parameter \\
Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
            & \texttt{const hdrl\_spectrum1D * output}\\
General description: & Calculates a blackbody spectrum for the \ac{RSRF} normalisation\\
Mathematical description: &  usual Planck formula\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Normalise RSRF}\label{drl:normrsrf}\label{drl:norm_flat}
\begin{recipedef}\label{drl:normflat}
Name: & \hyperref[drl:norm_flat]{\DRL{norm_flat}} \\
Purpose: & Creates normalised flats from \hyperref[dataitem:lm_lss_rsrf_raw]{\PROD{LM_LSS_RSRF_RAW}} / \hyperref[dataitem:n_lss_rsrf_raw]{\PROD{N_LSS_RSRF_RAW}}\\
Used in recipes: & \hyperref[rec:metis_lm_lss_rsrf]{\REC{metis_LM_lss_rsrf}} \\
& \hyperref[rec:metis_n_lss_rsrf]{\REC{metis_N_lss_rsrf}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
%Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Creates normalised \ac{RSRF} \\
Mathematical description: &  see~\cite{pis02} and~\cite{pis21}\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Normalise spectrum}\label{drl:normspec}\label{drl:norm_spec}
\begin{recipedef}\label{drl:norm_tss}
Name: & \hyperref[drl:norm_spec]{\DRL{norm_spec}} \\
Purpose: & Creates unity-normalised version from an input \ac{STD} spectra \\
Used in recipes: & \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \\
& \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
%Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Creates normalised version of a \ac{STD} input spectrum  by fitting the continuum and subsequent division of the fit\\
Mathematical description: &  Polynomial fit on regions known to contain continuum only; these regions will be defined in Table \hyperref[dataitem:ref_std_cat]{\STATCALIB{REF_STD_CAT}}\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
%\subsubsection{Detect order traces}\label{drl:tracedetect}
%Used in recipes:\\ 
%\hyperref[rec:metis_lm_lss_trace]{\REC{metis_LM_lss_trace}} \newline
%\hyperref[rec:metis_n_lss_trace]{\REC{metis_N_lss_trace}} \newline
%TBD



%---------------------------------------------------------------------
\subsubsection{Apply RSRF}\label{drl:applyrsrf}\label{drl:apply_rsrf}
\begin{recipedef}
Name: & \hyperref[drl:apply_rsrf]{\DRL{apply_rsrf}}\\
Purpose: & applies \hyperref[dataitem:master_lm_lss_rsrf]{\PROD{MASTER_LM_LSS_RSRF}} to LM-frames\newline
           applies \hyperref[dataitem:master_n_lss_rsrf]{\PROD{MASTER_N_LSS_RSRF}} to N-frames\\
Used in recipes: & \hyperref[rec:metis_lm_lss_trace]{\REC{metis_LM_lss_trace}} \newline
                 \hyperref[rec:metis_n_lss_trace]{\REC{metis_N_lss_trace}} \newline
                 \hyperref[rec:metis_lm_lss_wave]{\REC{metis_LM_lss_wave}} \newline
                 \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \newline
                 \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \newline
                 \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}} \newline
                 \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}} \newline 
                 \hyperref[rec:metis_lm_adc_slitloss]{\REC{metis_lm_adc_slitloss}} \newline
                \hyperref[rec:metis_n_adc_slitloss]{\REC{metis_n_adc_slitloss}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
%Input FITS files: & None \\
Inputs: & \texttt{const hdrl\_image * input}\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Normal flatfield process for correcting pixel-to-pixel sensitivities \\
Mathematical description: & Division by \hyperref[dataitem:master_lm_lss_rsrf]{\PROD{MASTER_LM_LSS_RSRF}} or  \hyperref[dataitem:master_n_lss_rsrf]{\PROD{MASTER_N_LSS_RSRF}}, respectively \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%%---------------------------------------------------------------------
%\subsubsection{Wavelength calibration}\label{drl:wavecal}
%\begin{recipedef}\label{drl:wavecal}
%Name: & \hyperref[drl:wave_cal]{\DRL{wave_cal}} \\
%Purpose: & Computes wavelength calibration \\
%Used in recipes: & \hyperref[rec:metis_lm_lss_wave]{\REC{metis_LM_lss_wave}} \\
%%Working remarks: & None \\
%%Function Parameters: & None \\
%Input: & \texttt{const hdrl\_image * input} \\https://www.overleaf.com/project/5f1abb4137d7690001f8aeb1
%%Other inputs: & None\\
%%QC outputs: & None \\
%%Output FITS files: & None \\
%Other outputs: & \texttt{cpl\_error\_code} \\
%General description: & Determines wavelength calibration by means of line lamp spectra \\
%Mathematical description: &  see~\cite{pis02} and~\cite{pis21}\\
%Quality assessment: & Through QC parameters \\
%Error conditions: & See~\cite{DRLVT}. \\
%Unit tests: & See~\cite{DRLVT}. \\
%\end{recipedef}

%---------------------------------------------------------------------
%\subsubsection{Detect line peak}\label{drl:linedetect}
%Used in recipes:\\ 
%\hyperref[rec:metis_lm_lss_wave]{\REC{metis_LM_lss_wave}} \newline
%\hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \newline
%\hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \newline
%\hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}} \newline
%\hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}} \newline
%TBD



%---------------------------------------------------------------------
\subsubsection{Determine response}\label{drl:determine_response}
\begin{recipedef}
Name: & \hyperref[drl:determine_response]{\DRL{determine_response}}\\
Purpose: & Determination of the spectral response function\\
Used in recipes: &  \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \newline
                 \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_spectrum1D * input} \\
Other inputs: & \texttt{const hdrl\_spectrum1D * input}\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Determination of the instrumental response function to be used for the absolute flux calibration \\
Mathematical description: & see HDRL manual \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}
%---------------------------------------------------------------------
\subsubsection{Remove sky background}\label{drl:remove_sky_background}
\begin{recipedef}\label{rec:removeskybackground}
Name: & \hyperref[drl:remove_sky_background]{\DRL{remove_sky_background}} \\
Purpose: & Remove sky background from spectra \\
Used in recipes: & \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \\
& \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}}\\
& \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \\
& \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Removes the sky emission background (nodding/chop-nodding technique) \\
Mathematical description: &  see~\cite{METIS-operational_concept}, Section 1.4\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Slit curvature detection}\label{drl:slit_curvature}
\begin{recipedef}\label{rec:slitcurvature}
Name: & \hyperref[drl:slit_curvature]{\DRL{slit_curvature}} \\
Purpose: & Determines the slit curvature along the orders \\
Used in recipes: & \hyperref[rec:metis_lm_lss_wave]{\REC{metis_LM_lss_wave}} \\
& \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \\
& \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}}\\
& \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \\
& \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Determines the tilt and shear of the orders using the sky emission lines \\
Mathematical description: &  see~\cite{pis02} and~\cite{pis21}\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Order trace detection}\label{drl:detect_order_trace}
\begin{recipedef}\label{rec:detectordertrace}
Name: & \hyperref[drl:detect_order_trace]{\DRL{detect_order_trace}} \\
Purpose: & Determines the order traces on the detectors\\
Used in recipes: & \hyperref[rec:metis_lm_lss_wave]{\REC{metis_LM_lss_wave}} \\
& \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \\
& \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}}\\
& \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \\
& \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Determines the order locations on the detectors \\
Mathematical description: &  see~\cite{pis02} and~\cite{pis21}\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Object extraction}\label{drl:extract_object}
\begin{recipedef}
Name: & \hyperref[drl:extract_object]{\DRL{extract_object}}\\
Purpose: & Extract object spectrum from 2D-spectrum\\
Used in recipes: & \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \newline
                 \hyperref[rec:metis_n_lss_std]{\REC{metis_N_lss_std}} \newline
                 \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}} \newline
                 \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input\newline const hdrl\_image * background\newline hdrl\_image * output}  \\
%Other inputs: & None\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Routine to extract a 1D spectrum of the target from the 2D spectrum\\
Mathematical description: & See optimal extraction algorithm~\cite{pis02} and~\cite{pis21} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Apply wavelength calibration}\label{drl:apply_wavecal}
\begin{recipedef}
Name: & \hyperref[drl:apply_wavecal]{\DRL{apply_wavecal}}\\
Purpose: & applies \hyperref[dataitem:lm_lss_wave_guess]{\PROD{LM_LSS_WAVE_GUESS}}\\
Used in recipes: & \hyperref[rec:metis_lm_lss_std]{\REC{metis_LM_lss_std}} \newline
                 \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
%Input FITS files: & None \\
Inputs: & \texttt{const hdrl\_spectrum1D * input}\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Applies the first guess wavelength calibration to LM LSS data \\
%Mathematical description: & Applies projection from detector space to $(y, \lambda)$-space\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Apply flux calibration}\label{drl:apply_fluxcal}
\begin{recipedef}
Name: & \hyperref[drl:apply_fluxcal]{\DRL{apply_fluxcal}}\\
Purpose: & applies \hyperref[dataitem:master_lm_response]{\PROD{MASTER_LM_RESPONSE}} or \hyperref[dataitem:master_n_response]{\PROD{MASTER_N_RESPONSE}} to science frames\\
Used in recipes: & \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}} \newline
                 \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
%Input FITS files: & None \\
Inputs: & \texttt{const hdrl\_spectrum1D * input}\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Applies the absolute flux calibration to science frames \\
%Mathematical description: & Applies projection from detector space to $(y, \lambda)$-space\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

%---------------------------------------------------------------------
\subsubsection{Apply telluric correction}\label{drl:apply_tellcorr}
\begin{recipedef}
Name: & \hyperref[drl:apply_tellcorr]{\DRL{apply_tellcorr}}\\
Purpose: & applies \hyperref[dataitem:lm_synth_trans]{\STATCALIB{LM_SYNTH_TRANS}} and \hyperref[dataitem:n_synth_trans]{\STATCALIB{N_SYNTH_TRANS}} to corresponding standard star spectrum (\hyperref[dataitem:lm_lss_std_1d]{\PROD{LM_LSS_STD_1D}} and \hyperref[dataitem:n_lss_std_1d]{\PROD{N_LSS_STD_1D}})\\
Used in recipes: & \hyperref[rec:metis_lm_lss_sci]{\REC{metis_LM_lss_sci}} \\
                 & \hyperref[rec:metis_n_lss_sci]{\REC{metis_N_lss_sci}} \\
%Working remarks: & None \\
%Function Parameters: & None \\
%Input FITS files: & None \\
Inputs: & \texttt{const hdrl\_spectrum1D * input}\\
%QC outputs: & None \\
%Output FITS files: & None \\
Other outputs: & \texttt{cpl\_error\_code} \\
General description: & Applies a simple transmission to \ac{STD} spectra better determine the response curve \\
%Mathematical description: & Applies projection from detector space to $(y, \lambda)$-space\\
Quality assessment: & Through QC parameters \\
Error conditions: & See~\cite{DRLVT}. \\
Unit tests: & See~\cite{DRLVT}. \\
\end{recipedef}

