%% METIS_DRLD.tex
%%
%% METIS data reduction library design document
%%
%% 2020-05-27: initialised from specification document (OC)
%% 2020-09-07: MTR release (OC)

\newcommand{\doctitle}{%
  \parbox[t]{\textwidth}{Data Reduction Library\\Design}}
\newcommand{\docnumber}	{E-REP-AST-MET-1006}     % Document number
\newcommand{\issuenumber}{0-3.5}                % Version
\newcommand{\issuedate}{2023-05-26}              % Date
\newcommand{\workpackage}{8.2}      % Workpackage

% The purpose of texorpdfstring is to provide different
% strings for the title page (tex string) and for the pdf bookmark
% (via hyperref, no tex formatting allowed).
% The two versions need to be kept in sync.
\newcommand{\authorname}{\texorpdfstring{%  % Authors
  O.~Czoske,\\                        % tex string
  W.~Kausch,\\
  N.~Sabha,\\
  W.~Zeilinger}
  {Czoske, Kausch, Sabha, Zeilinger}  % pdf string
  }

\newcommand{\authorsigndate}  {} % date of signature of author

\newcommand{\reviewername}     {%
}       % checked by name
\newcommand{\reviewersigndate} {} % date of signature of checker

\newcommand{\approvername}    {%
}       % name of the approver
\newcommand{\approvalsigndate}{} % date of signature of approver

\newcommand{\releasername}{%
}
\newcommand{\releasesigndate}{}  % date of release

% Title displayed in the header
\newcommand{\shorttitle}{Data Reduction Library Design}


\newcommand{\aj}{The Astronomical Journal}
\newcommand{\aap}{Astronomy \& Astrophysics}
\newcommand{\aaps}{Astronomy \& Astrophysics, Supplement}
\newcommand{\mnras}{Monthly Notices of the Royal Astronomical Society}
\newcommand{\procspie}{Proceedings of the International Society for Optical Engineering}
\newcommand{\pasp}{Publications of the Astronomical Society of the Pacific}
\newcommand{\apjs}{The Astrophysical Journal, Supplement}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[11pt,oneside,a4paper]{article}

%% Layout  --- TeX commands
\raggedbottom
\topmargin=-9mm
\headsep=0.5cm
\textheight=246mm
\textwidth=164mm
\hoffset=0cm
\oddsidemargin=-2mm
\parindent=0mm
\parskip=0.3em

\renewcommand{\floatpagefraction}{0.98} % separate float page does not work
\renewcommand{\bottomfraction}{1.0}

%% Fonts
\usepackage{mathptmx}
\usepackage[scaled=0.92]{helvet}

\usepackage[pdftex]{graphicx}
\graphicspath{{./figures/}}

\usepackage{fancyhdr}
\setlength{\headheight}{19pt} % ...at least 18.26802pt
\setlength{\footskip}{31pt}   % ...at least 30.86163pt
\usepackage{titlesec}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{array}
\usepackage{longtable}
\usepackage{numprint}
\usepackage{placeins}
\usepackage{enumitem}
\usepackage{acronym}
\usepackage[dvipsnames]{xcolor}
\usepackage{xcolor}
\usepackage{colortbl}
\definecolor{listingbg}{gray}{0.95}
\definecolor{darkgreen}{rgb}{0.0, 0.7, 0.0}
\definecolor{darkblue} {rgb}{0.0, 0.0, 0.7}
\definecolor{darkred}  {rgb}{0.7, 0.0, 0.0}
\definecolor{darkorange}{rgb}{1.0, 0.49, 0.0}

\usepackage[many]{tcolorbox}
\usepackage{multirow}

% does not work with my version of biblatex:
% \usepackage[defernumbers=true,backend=biber,hyperref=true,url=false]{biblatex}
\usepackage[%
   defernumbers=true,
   backend=biber,
   hyperref=true,
   url=false,
   sorting=none]{biblatex}

\usepackage[%
% pagebackref=true,   % does not work with biblatex
   pdfpagelabels=true,
   plainpages=false,
   colorlinks=false]{hyperref}


% Git stuff, must by after hyperref
% The git hash and commit date will be shown when compiling with --shell-escape
% https://tex.stackexchange.com/a/598669/2775
\newif\ifshowgit  % flag to show git info instead of Issue info
% "The control sequence \pdfshellescape is (only?) available in pdftex"
% http://tex.stackexchange.com/a/13253/2595
\ifnum\pdfshellescape=1{ %
    % Check for overleaf https://tex.stackexchange.com/a/598669/2775
    \ifnum\pdfstrcmp{\jobname}{output}=0
        % Apparently overleaf does not compile from their git repo.
        \showgitfalse
    \else
        \usepackage[noheader]{gitver}
        \def\parsegitdate#1-#2-#3 #4\endparse{#3.#2.#1}
        \makeatletter
            \edef\gitdate{\@@input|"git log -1 --format=\@percentchar ci"}
        \makeatother
        \showgittrue
    \fi
\else
    \showgitfalse
\fi


% does not work with my version:
%\usepackage[xindy,nopostdot,nogroupskip]{glossaries}
\usepackage[xindy]{glossaries}
%\makeglossaries

\usepackage{lastpage}
\usepackage{multirow}
\usepackage[%
   font=small,
   format=plain,
   indention=1.5em,
   labelfont={small,bf},
   up,
   justification=justified,
   singlelinecheck=true]{caption}

%% for sidewaysfigure and sidewaystable
\usepackage{rotating}

%% for landscape
\usepackage{pdflscape}

% for newgeometry and restoregeometry
\usepackage{geometry}

%% put recipe names, QC parameters, etc., in \lstinline{}
\usepackage{listings}
\lstloadlanguages{csh, c}

\usepackage{textcomp}

\usepackage{csquotes}

\usepackage[countmax]{subfloat}
% ADDING NEW DEFINITIONS -------------------------------------------- start
\definecolor{listingbg}{gray}{0.95}
\definecolor{darkgreen}{rgb}{0.0, 0.7, 0.0}
\definecolor{darkblue} {rgb}{0.0, 0.0, 0.7}
\definecolor{cyan} {rgb}{0.0, 0.4, 0.4}
\definecolor{darkred}  {rgb}{0.7, 0.0, 0.0}
\definecolor{darkorange}{rgb}{1.0, 0.49, 0.0}
\definecolor{violett}{rgb}{255, 0, 255}
\definecolor{turq}{rgb}{0.0, 0.7, 0.8}
\definecolor{fits}{rgb}{0.4, 0.1, 1}


\makeatletter
\newcommand{\replaceunderscores}[1]{\expandafter\replace@underscores#1_\relax}

\def\replace@underscores#1_#2\relax{%
    \ifx \relax #2\relax
        #1%
    \else
        #1%
        \textunderscore
        \replace@underscores#2\relax
    \fi
}
\makeatother

%\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}
%% Write a raw FITS file like this: \hyperref[dataitem:lm_sci_raw]{\RAW{LM_SCI_RAW}}
\makeatletter
\lstdefinestyle{RAWstyle}{%
  basicstyle=\ttfamily\color{fits}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\RAW}[1]{\lstinline[style=RAWstyle]!#1!}

%% Write parameters like this: \PAR{DARK_LM}
\makeatletter
\lstdefinestyle{PARstyle}{%
  basicstyle=\ttfamily\color{cyan}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\PAR}[1]{\lstinline[style=PARstyle]!#1!}

%% Write DRL functions names like this: \DRL{function}
\makeatletter
\lstdefinestyle{DRLstyle}{%
  basicstyle=\ttfamily\color{violett}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\DRL}[1]{\lstinline[style=DRLstyle]!#1!}

%% Write recipe names like this: \REC{metis_do_stuff}
\makeatletter
\lstdefinestyle{RECstyle}{%
  basicstyle=\ttfamily\color{darkgreen}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\REC}[1]{\texorpdfstring{\lstinline[style=RECstyle]!#1!}{\replaceunderscores{#1}}}

%% Write QC parameters like this: \QC{QC_SOMETHING_OR_OTHER}
\makeatletter
\lstdefinestyle{QCstyle}{%
  basicstyle=\ttfamily\color{darkblue}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\QC}[1]{\lstinline[style=QCstyle]!#1!}

%% Write templates like this: \TPL{DARK_LM}
\makeatletter
\lstdefinestyle{TPLstyle}{%
  basicstyle=\ttfamily\color{darkred}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\TPL}[1]{\lstinline[style=TPLstyle]!#1!}

%% Write products like this: \hyperref[dataitem:some_thing]{\PROD{SOME_THING}}
\makeatletter
\lstdefinestyle{PRODstyle}{%
  basicstyle=\ttfamily\color{darkorange}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\PROD}[1]{\lstinline[style=PRODstyle]!#1!}

%% Write requirements like this: \REQ{METIS-xxxx}
\newcommand{\REQ}[1]{\href{https://polarion.astron.nl/polarion/\#/project/METIS/workitem?id=#1}{\textcolor{brown}{#1}}}

%% external calib files
\makeatletter
\lstdefinestyle{EXTCALIBstyle}{%
  basicstyle=\ttfamily\color{Turquoise}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\EXTCALIB}[1]{\lstinline[style=EXTCALIBstyle]!#1!}

% static calib files
\makeatletter
\lstdefinestyle{STATCALIBstyle}{%
  basicstyle=\ttfamily\color{teal}%
  \lst@ifdisplaystyle\scriptsize\fi}
\makeatother
\newcommand{\STATCALIB}[1]{\lstinline[style=STATCALIBstyle]!#1!}

%% Write FITS keywords (and values) like this: \FITS{EXPTIME}
\newcommand{\FITS}[1]{\lstinline[]!#1!}

%% Write code snippets like this: \CODE{SOMETHING==ELSE}
%% (I know, this is a bit stupid)
\newcommand{\CODE}[1]{\lstinline[]!#1!}

%% Use environment recipedef to define a new recipe.
\newenvironment{recipedef}
{% begin code
  \begin{tcolorbox}[breakable,enhanced jigsaw]%
    \begin{longtable}{p{0.24\hsize}p{0.69\hsize}}}
      {% end code
    \end{longtable}%
  \end{tcolorbox}}

%% Use environment datastructdef to define the data structure of a data item (see e.g. LSS_data_structures.tex)
\newenvironment{datastructdef}
{% begin code
  \begin{tcolorbox}[breakable,enhanced jigsaw]%
    \begin{longtable}{p{0.97\hsize}}}
      {% end code
    \end{longtable}%
  \end{tcolorbox}}


%%%%% This is a definition that has the flow diagram within the box:
%% \newcommand{\theimage}{}  % dummy definition
%% \newenvironment{recipedef}[1]
%% {% begin
%% code
%% \renewcommand{\theimage}{#1}
%% \begin{tcolorbox}%
%%   \begin{tabular}{p{0.24\hsize}p{0.74\hsize}}
%%   }%
%%     {% end code
%%   \end{tabular}%
%%   \begin{center}%
%%     \includegraphics[width=0.6\textwidth]{\theimage}%
%%   \end{center}%
%% \end{tcolorbox}}




%% Proper typography for micrometer
\newcommand{\micron}{\textmu\mathrm{m}}
\newcommand{\mat}[1]{\mathbf{#1}}
\newcommand{\abs}[1]{\lvert#1\rvert}

%% Ion
\DeclareRobustCommand{\ion}[2]{%
  \textup{#1{\mdseries\textsc{#2}}}%
}

%%%% \la...kleiner als ungef"ahr
\def\la{\mathrel{\mathchoice {\vcenter{\offinterlineskip\halign{\hfil
          $\displaystyle##$\hfil\cr<\cr\sim\cr}}}
    {\vcenter{\offinterlineskip\halign{\hfil$\textstyle##$\hfil\cr
          <\cr\sim\cr}}}
    {\vcenter{\offinterlineskip\halign{\hfil$\scriptstyle##$\hfil\cr
          <\cr\sim\cr}}}
    {\vcenter{\offinterlineskip\halign{\hfil$\scriptscriptstyle##$\hfil\cr
          <\cr\sim\cr}}}}}

%%%% \ga...Gr"o"ser als ungef"ahr
\def\ga{\mathrel{\mathchoice {\vcenter{\offinterlineskip\halign{\hfil
          $\displaystyle##$\hfil\cr>\cr\sim\cr}}}
    {\vcenter{\offinterlineskip\halign{\hfil$\textstyle##$\hfil\cr
          >\cr\sim\cr}}}
    {\vcenter{\offinterlineskip\halign{\hfil$\scriptstyle##$\hfil\cr
          >\cr\sim\cr}}}
    {\vcenter{\offinterlineskip\halign{\hfil$\scriptscriptstyle##$\hfil\cr
          >\cr\sim\cr}}}}}

%%%% Degrees, arcmin, arcsec
\def\degr{\hbox{$^\circ$}}

\def\arcmin{\hbox{$^\prime$}}

\def\arcsec{\hbox{$^{\prime\prime}$}}

%% Bright red for things that still need to be looked at. None of
%% these should appear in the release version
\newcommand{\TODO}[1]{\textcolor{red}{\bfseries TODO: #1}}
\newcommand{\TBD}{\textcolor{red}{\bfseries TBD}}

\newcommand{\intentblankpage}{}

%% paragraph column, centred text
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}

%=== Header / Footer definition ===============================================
\newcommand{\headerformat}{%
  \lhead{\small\sffamily
    \begin{tabularx}{\textwidth}{Xlll}
      \ifshowgit
      \shorttitle & \docnumber & GIT \ \gitVer & \gitdate\\[0.7ex]
      \else
      \shorttitle & \docnumber & \issuenumber & \issuedate\\[0.7ex]
      \fi
    \end{tabularx}}
  \rhead{}
  \cfoot{\small\bfseries\sffamily
    Page {\textbf{\thepage}}  of {\textbf{\pageref{LastPage}}} }
  \rfoot{\raisebox{-0.3\height}{\includegraphics[width=25mm]{metis_noText.pdf}} }
}

\fancypagestyle{plain}{\fancyhf{} \headerformat}
\headerformat
\definecolor{brn}{RGB}{99,36,35}
\definecolor{rd1}{RGB}{229,184,183}
\definecolor{rd2}{RGB}{242,219,219}

\renewcommand\headrule{%
  \begingroup
  \color{brn}
  \hrule height 0.5pt width\headwidth
  \endgroup
}

\renewcommand{\contentsname}{Table of Contents}

%% ---- Format of section titles --------------------------------
% Combining sffamily and scshape works only for some fonts
\titleformat{\section}{\LARGE\sffamily\scshape}{\thesection}{1em}{\textsc{}}
\titleformat{\subsection}{\Large\sffamily}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\large\sffamily}{\thesubsubsection}{1em}{}

\setlength\heavyrulewidth{1.5pt}


% === PDF Definition ==========================================================
\hypersetup{%
  setpagesize,
  bookmarksnumbered=true,
  pdfborder= 0 0 0,
  pdftitle={\shorttitle},
  pdfauthor={\authorname}}
%\pdfinfo{ /CreationDate (D:\issuedate)}


% === biblatex Definitions ====================================================
\bibstyle{apj}
\addbibresource{references.bib}
\newbibmacro{string+doiurlisbn}[1]{\iffieldundef{url}{#1}{\href{\thefield{url}}{#1}}}
\DeclareFieldFormat{title}{\usebibmacro{string+doiurlisbn}{\mkbibemph{#1}}}


% === glossaries definitions  =================================================
% \input{../common/metis_glossary.tex}     % the common glossary file
\renewcommand{\glossarysection}[2][]{}   % Avoid the heading 'Glossary'
\setlength{\LTleft}{0pt}                 % make all longtables aligned left
\setlength{\glsdescwidth}{0.8\textwidth}

% === Headers for notebook rendering ==========================================
\input{JuPyter_header}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Start of document
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\begin{document}

% listings style
\lstset{basicstyle=\ttfamily\lst@ifdisplaystyle\scriptsize\fi,
  columns=flexible,
  frame=single,
  backgroundcolor=\color{listingbg},
  captionpos=b,
  showspaces=false}


\input{00-Titlepage}

% === MAIN TEXT================================================================

\clearpage
\pagestyle{fancy}

% === Revision History =========================================================
\section*{Revision History}

\renewcommand{\arraystretch}{1.2}
\arrayrulecolor{brn}
\begin{tabularx}{\textwidth}{|l|l|l|X|}
  \hline
  \rowcolor{rd1}
  \textbf{Issue} & \textbf{Date} & \textbf{Owner} & \textbf{Changes} \\
  \hline
                 & 2020-05-27    & Czoske         & initial draft    \\
  0.1            & 2020-09-27    & all            & MTR release      \\
  0.2            & 2022-06-30    & all            & preliminary internal release      \\
  0.3            & 2022-09-07    & LSS Sections   & Internal review \\
  0.35           & 2023-05-26    & telluric correction revision   & Internal review \\
  \hline
\end{tabularx}


%=== Indexes ==================================================================
\newpage
\tableofcontents
\clearpage
\listoffigures
\clearpage
\listoftables

\clearpage
\phantom{a}
\vfill
\begin{center}
  This page intentionally left blank
\end{center}
\vfill
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% INTRODUCTION
\section{Introduction}
\label{sec:intro}

\subsection{Scope}

This document describes the design of the data reduction software for
METIS, the Mid-infrared ELT Imager and Spectrograph. It builds upon
the Data Reduction Library Specifications document \cite{DRLS}
presented for \ac{PDR} and supersedes that document for \ac{FDR}.

\subsection{Applicable documents}

\begin{refcontext}[labelprefix=AD]
  \printbibliography[keyword=applicable, heading=none]
\end{refcontext}


\subsection{Reference documents}

\begin{refcontext}[labelprefix=RD]
  \printbibliography[keyword=reference, heading=none]
\end{refcontext}

\subsection{Acronyms}
\label{ssec:acronyms}
\input{acronyms.tex}

\subsection{Requirements}
\label{ssec:requirements}
\input{Requirements}

\clearpage


\input{02-Instrument_Modes}
\input{03-Instrument_Data_Description}

% General part on pipeline and DFS
\input{05_0-Data_Processing_Overview}

% Imaging-mode
% \input{05_1-Overview_Imaging}

% LSS-mode
% \input{Overview_LSS}  % TO BE EDITED BY INNSBRUCK ONLY!!!!!

\clearpage
% IFU-mode
% \input{05_3-Overview_IFU}

\clearpage
\input{06_0-Algorithms}


\input{07_0-Pipeline_Recipes}
% \input{06_1a-Recipes_Detector}
% \newpage
% \input{06_1b-Recipes_Imaging_LM}
% \input{06_2-Recipes_Imaging_NQ}
% \input{Recipes_LSS_LM}
% \input{06_4-Recipes_LSS_N}
% \input{06_5-Recipes_IFU}
% \input{06_6-Recipes_HCI}


% \subsection{Specifications and requirements}
% \label{Subsec:polarion}
% \input{01-Requirements}

\input{08_0-DRL-Functions}

\input{09_0-DRL-Data-Structures}
\input{10_0-HDRL_algorithms}
\input{11_0-critical_algorithms}
\input{12_0-QC_parameters}
\input{13_0-Developmentplan}

\appendix
\input{App01_Product_files}
\input{App02_FITS_keywords}
\input{App03_AtmoTrans}

\end{document}

%%
%% THE END
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
