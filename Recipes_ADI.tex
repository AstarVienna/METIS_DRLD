
\subsection{ADI Post Processing}
\label{}



The following recipes can be used by astronomers in an offline way
perform basic ADI processing on data which have already undergone
basic calibration, via the standard LM/N processing methods.  As it
relies on reduced data they will not be executed in a scheduled way at
the telescope. For more detailed HCI reductions the observers will
have to rely on their own more specialized code, but intermediate data
products will be optionally provided in these recipes to facilitate
their dedicated HCI reductions. [potentially these three recipes can
  be combined into one with a logical decision tree] [to minimize
  interpolation artefacts any interpolation steps are to be combined
  as much as possible] [bad pixel maps and image stacks without
  background subtraction should be available as output from the
  earlier science processing recipes]

\subsubsection{IMG\_LM/N RAVC/CVC(/CLC) ADI Post Processing}
\label{}


The following recipe is applicable for ADI post processing for the LM
and N band, and CVC/RAVC(/CLC) coronagraphs. An input set of
observations consists of a time sequence of ADI images in LM/N band, which
have already undergone basic calibration.

For each image, the centroid of the central source is determined,
distortion corrections are performed, and the images are aligned on a
subpixel scale. The median PSF is then estimated and subtracted from
all images following the first step of the standard ADI technique of Marois et al (2006). 
Each image is then derotated using the known position angle and
coadded to produce the final science image. In addition, the images
prior to PSF subtraction are derotated and combined to produce a second final
image.

In addition to the final images, the cube of derotated, PSF subtracted
images are used to calculate the raw and post-ADI contrast curves
as well as the ADI throughput curve. The intrinsic radial throughput of the coronagraph 
is taken from static calibrations while the post-processing losses are estimated from injection 
and retrieval of artificial companions with a known brightness and separation.

[Off-axis unsaturated PSFs which are needed for the ADI process are
  either collected as part of the observations, static calibrations or
  available from the QACITS control loop.  If collected as part of the
  OB they are processed by the regular science recipes (with
  compensation of any neutral density transmission).]

[while not part of the PIP specs, the current generation of VIP\_HCI
  ADI reduction algorithms supports the more detailed Marois et
  al. 2006 ADI (including an annular optimization step) as well as
  PCA-based routines.]

\begin{recipedef}
  Name:                & \REC{metis_lm_adi_ravc}                                        \\
  Purpose:             & Classical ADI post processing for CVC/RAVC(/CLC) coronagraphs      \\
  Requirements:        & \REQ{METIS-5989}                                               \\
  Type:                & Science                                                    \\
  Templates:           & \TPL{LM_SCI_Reduced}                            \\
  Input data:          & Time series of LM\_SCI\_REDUCED images                      \\
                       & LM distortion table                               \\
                       & Coronagraphic throughput map and profile                                                  \\
                       & Off-axis PSF references                                                  \\
                       &                                                  \\
   Matched keywords:   &              \\
                       &               \\
                       &               \\
                       &               \\
                       &               \\
  Recipe parameters:   &  combination approach (median,mean,sigclip) \\
                       &   combination parameters (e.g., N-sigma)          \\
                       &  start and end limit to contrast curve (in lambda/D) \\
  & frame exclusion thresholds dependent on AO parameters and centroid offset                \\
  
  Algorithm:           & Determine centroid of central source \\
                       & Distortion correction and sub-pixel alignment   \\
                       & Estimate median PSF   \\
                       & Subtract median PSF   \\
                       & De-rotate images   \\
                       & Coadd images   \\
  & Calculate contrast curve   \\
  Output data:       & \PROD{LM_RAVC_SCI_CALIBRATED} (Calibrated Image)                                    \\
                     & \PROD{LM_RAVC_SCI_CENTRED} (Cube of individually calibrated and recentered images)                                 \\
                     & \PROD{LM_RAVC_CENTROID_TAB} (Table of star centre estimages)                                 \\
              
                     & \PROD{LM_RAVC_SCI_SPECKLE} (PSF/speckle image)                                 \\
                     & \PROD{LM_RAVC_SCI_DEROTATED_PSFSUB_COADD} (Combined derotated image with PSF subtraction)                                 \\
                     & \PROD{LM_RAVC_SCI_DEROTATED_COADD} (Combined derotated image without PSF subtraction)                                  \\
                     & \PROD{LM_RAVC_SCI_CONTRAST_RAW} (Raw Contrast Curve)                                 \\
                     & \PROD{LM_RAVC_SCI_CONTRAST_ADI} (Post ADI Contrast Curve)                                 \\
                     & \PROD{LM_RAVC_SCI_THROUGHOUT} (ADI Throughput Curve)                               \\
                     & \PROD{LM_RAVC_SCI_SNR} (ADI SNR Map)                            \\

  Expected accuracies: & \TBD                                                           \\
  QC1 parameters:      & \QC{FWHM of PSF by frame}                                      \\
                       & \QC{Raw and post ADI contrast at seps (1,2,5,10,20,40 lam/D)}                                        \\
                       & \QC{Mean SNR in ADI map}                                        \\
                       & \QC{Peak SNR in ADI map}                                         \\
  hdrl function        & \CODE{}                                    \\
                       & \CODE{}                                 \\
                       & \CODE{}                                \\
\end{recipedef}

\begin{figure}[hb]
  \centering
  \includegraphics[width=0.6\textwidth]{./figures/metis_lm_adi_ravc}
  \caption[Recipe: \REC{metis_lm_adi_ravc}]{\REC{metis_lm_adi_ravc} -- LM ADI post processing for RAVC/CVC(/CLC) coronagraph. 
    }
  \label{fig:metis_lm_adi_ravc}
\end{figure}




\subsubsection{IMG\_LM/N APP ADI Post Processing}
\label{}


The following recipe is applicable for ADI post processing for the LM
and N band, in combination with the APP coronagraph. It is very similar to the recipe for
RAVC/CVC(/CLC) coronagraphs, with the addition of steps to merging together the two half PSFs, and of applying an
angular wedge mask before the derotation and stacking, and contrast curve calculations. An input set of observations consists 
of a time sequence of ADI images in LM/N band, which have already undergone basic calibration.

For each image, the centroid of the central source is determined for all three PSFs and
distortion corrections are performed. The PSFs are aligned at a sub-pixel scale and extracted;
the extracted coronagraphic PSFs are merged to produce a complete PSF and the third PSF is used to form a cube of calibrated leakage PSFs.
The mean/median/sigmaclipped PSF is estimated and subtracted from each frame of the merged coronagraphic PSF. Each image is
then derotated to place the off-axis source at the same on-sky angle
and coadded to produce the final science image. In addition, the
images prior to PSF subtraction are derotated and combined to produce
a final image.

In addition to the final images, the stack derotated, PSF subtracted
images are used to calculate the raw and post-ADI contrast curves
as well as the ADI throughput curve.



\begin{recipedef}
  Name:                & \REC{metis_lm_adi_app}                                        \\
  Purpose:             & Classical ADI post processing for APP coronagraph      \\
  Requirements:        & \REQ{METIS-5989}                                               \\
  Type:                & Science                                                    \\
  Templates:           & \TPL{LM_SCI_Reduced}                            \\
  Input data:          & Time series of LM\_SCI\_REDUCED images                      \\
                       & LM distortion table                               \\
                       & Off-axis PSF reference                                                  \\
                       &                                                  \\
   Matched keywords:   &              \\
                       &               \\
                       &               \\
                       &               \\
                       &               \\
  Recipe parameters:   &  combination approach (median,mean,sigclip) \\
                       &   combination parameters (e.g., N-sigma)          \\
                       &  start and end limit to contrast curve (in lambda/D) \\
  & frame exclusion thresholds dependent on AO parameters and centroid offset \\
                                                       
  Algorithm:           & Determine centroid of central source \\
                       & Distortion correction and sub-pixel alignment   \\
                       & sub-pixel PSF extraction and alignment   \\
                       & Merge coronagraphic PSFs   \\
                       & Estimate median PSF   \\
                       & Subtract median PSF   \\
                       & De-rotate images   \\
                       & Coadd images   \\
                       & Calculate contrast curves   \\
  & Calculate contrast curve   \\
  Output data:       & \PROD{LM_APP_SCI_CALIBRATED} (Calibrated Image)                                    \\
                     & \PROD{LM_APP_SCI_CENTRED} (Cube of individuallly calibrated and recentered images)                                 \\
                     & \PROD{LM_APP_CENTROID_TAB} (Table of star centre estimages)                                 \\
              
                     & \PROD{LM_APP_SCI_SPECKLE} (PSF/speckle image)                                 \\
                     & \PROD{LM_APP_SCI_DEROTATED_PSFSUB} (Combined derotated image with PSF subtraction)                                 \\
                     & \PROD{LM_APP_SCI_DEROTATED_COADD} (Combined derotated image without PSF subtraction)                                  \\
                     & \PROD{LM_APP_SCI_CONTRAST_RAW} (Raw Contrast Curve)                                 \\
                     & \PROD{LM_APP_SCI_CONTRAST_ADI} (Post ADI Contrast Curve)                                 \\
                     & \PROD{LM_APP_SCI_THROUGHOUT} (ADI Throughput Curve)                               \\
                     & \PROD{LM_APP_SCI_SNR} (ADI SNR Map)                            \\

  Expected accuracies: & \TBD                                                           \\
  QC1 parameters:      & \QC{FWHM of PSF by frame}                                      \\
                       & \QC{Raw and post ADI contrast at seps (1,2,5,10,20,40 lam/D)}                                        \\
                       & \QC{Mean SNR in ADI map}                                        \\
                       & \QC{Peak SNR in ADI map}                                         \\
  hdrl function        & \CODE{}                                    \\
                       & \CODE{}                                 \\
                       & \CODE{}                                \\
\end{recipedef}

\begin{figure}[hb]
  \centering
  \includegraphics[width=0.6\textwidth]{./figures/metis_lm_adi_app}
  \caption[Recipe: \REC{metis_lm_adi_app}]{\REC{metis_lm_adi_app} -- LM ADI post processing for APP coronagraph. 
    }
  \label{fig:metis_lm_adi_app}
\end{figure}



\subsubsection{LMS ADI Post Processing}
\label{}


The following recipe is applicable for ADI post processing for the LMS
data cubes and the RAVC/CVC and APP coronagraphs. As only a single target can be targeted in the limited field of view the methods overlap between coronagraphs.
For the LMS observations, the input is a set of reduced 3D (spectral and spatial) data cubes on a rectified grid. 

For each wavelength slice in each cube the centroid is determined by a QACITS-like algorithm 
in the case of the focal plane coronagraphs (RAVC/CVC) or through 2D cross-correlation with 
a template PSF for the APP coronagraph. This centroid information is stored in a table together 
with timestamps, parallactic angle and bad frame flags (based on AO loop status, AO performance, 
atmospheric parameters and centroid offset).
As the ADI step requires square pixels following previous work on combining ADI techniques with IFUs (such as SPHERE/IFS, SINFONI), 
the rectangular spatial grid is interpolated or nearest neighbor filled to produce a square pixel image 
[it is acknowledged that one spatial dimension is undersampled which may lead to reduction artefacts].
The mean/median/sigmaclipped PSF (in time) is estimated for each wavelength and subtracted from each image in the cube. 
After derotation the cubes are combined in time to give a coadded cube. For the APP a wedge shape is used. The derotated cubes are also 
used to generate post ADI contrast curves and contrast curves with input from the radial coronagraph throughput profile and off-axis PSFs.

[while not part of the PIP specs, the current generation of VIP\_HCI ADI reduction algorithms supports
the more detailed Marois et al. 2006 ADI routine, PCA-based routines, as well as ADI+mSDI processing to improve the speckle PSF estimation.]



\begin{recipedef}
  Name:                & \REC{metis_lms_adi_ravc}                                        \\
  Purpose:             & Classical ADI post processing for CVC/RAVC(/CLC) coronagraphs      \\
  Requirements:        & \REQ{METIS-5989}                                               \\
  Type:                & Science                                                    \\
  Templates:           & \TPL{LM_SCI_Reduced}                            \\
  Input data:          & Time series of LM\_SCI\_REDUCED images                      \\
                       & LM distortion table                               \\
                       & Coronagraphic throughput map and profile                                                  \\
                       & Off-axis PSF references                                                  \\
                       &                                                  \\
   Matched keywords:   &              \\
                       &               \\
                       &               \\
                       &               \\
                       &               \\
  Recipe parameters:   &  combination approach (median,mean,sigclip) \\
                       &   combination parameters (e.g., N-sigma)          \\
                       &  start and end limit to contrast curve (in lambda/D) \\
  & frame exclusion thresholds dependent on AO parameters and centroid offset \\
                                                       
  Algorithm:           & Determine centroid of central source \\
                       & Distortion correction, square pixel reconstruction and sub-pixel alignment   \\
                       & Estimate median PSF   \\
                       & Subtract median PSF   \\
                       & De-rotate images   \\
                       & Coadd images   \\
                       & Calculate contrast curves   \\
  & Calculate contrast curve   \\
  Output data:       & \PROD{LM_RAVC_SCI_CALIBRATED} (Calibrated Cube)                                    \\
                     & \PROD{LM_RAVC_SCI_CENTRED} (Cube of individually calibrated and recentered cubes)                                 \\
                     & \PROD{LM_RAVC_CENTROID_TAB} (Table of star centre estimages)                                 \\
              
                     & \PROD{LM_RAVC_SCI_SPECKLE} (PSF/speckle cube)                                 \\
                     & \PROD{LM_RAVC_SCI_DEROTATED_PSFSUB} (Combined derotated cube with PSF subtraction)                                 \\
                     & \PROD{LM_RAVC_SCI_DEROTATED_COADD} (Combined derotated cube without PSF subtraction)                                  \\
                     & \PROD{LM_RAVC_SCI_CONTRAST_RAW} (Raw Contrast Curves)                                 \\
                     & \PROD{LM_RAVC_SCI_CONTRAST_ADI} (Post ADI Contrast Curves)                                 \\
                     & \PROD{LM_RAVC_SCI_THROUGHOUT} (ADI Throughput Curves)                               \\
                     & \PROD{LM_RAVC_SCI_SNR} (ADI SNR Map)                            \\

  Expected accuracies: & \TBD                                                           \\
  QC1 parameters:      & \QC{FWHM of PSF by frame}                                      \\
                       & \QC{Raw and post ADI contrast at seps (1,2,5,10,20,40 lam/D)}                                        \\
                       & \QC{Mean SNR in ADI map}                                        \\
                       & \QC{Peak SNR in ADI map}                                         \\
  hdrl function        & \CODE{}                                    \\
                       & \CODE{}                                 \\
                       & \CODE{}                                \\
\end{recipedef}

\begin{figure}[hb]
  \centering
  \includegraphics[width=0.6\textwidth]{./figures/metis_lms_adi_ravc}
  \caption[Recipe: \REC{metis_lms_adi_ravc}]{\REC{metis_lms_adi_ravc} -- LMS ADI post processing for RAVC coronagraph. 
    }
  \label{fig:metis_lms_adi_ravc}
\end{figure}
