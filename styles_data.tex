\makeatletter
\newcommand{\replaceunderscores}[1]{\expandafter\replace@underscores#1_\relax}

\def\replace@underscores#1_#2\relax{%
    \ifx \relax #2\relax
        #1%
    \else
        #1%
        \textunderscore
        \replace@underscores#2\relax
    \fi
}
\makeatother

\ExplSyntaxOn
% Generic \ITEM macro:
%   use \RAW*{WHATEVER_THIS_IS} where hyperlinks are not needed (TOC, sections...)
%   and \RAW{WHATEVER_THIS_IS} for a full hyperlink-enabled version in regular text and tikz figures
\NewDocumentCommand{\ITEM}{smm}{%
    \IfBooleanTF{#1}{%
        \texorpdfstring{\lstinline[style=#2style]!#3!}{\replaceunderscores{#3}}%
    }{%
        \hyperref[dataitem:\text_lowercase:n{#3}]{\lstinline[style=#2style]!#3!}%
    }%
}
\ExplSyntaxOff

% Raw FITS file: \RAW{LM_SCI_RAW}
\NewDocumentCommand{\NEWRAW}{s m}{\IfBooleanTF#1{\ITEM*{RAW}{#2}}{\ITEM{RAW}{#2}}}
\NewDocumentCommand{\NEWPAR}{s m}{\IfBooleanTF#1{\ITEM*{PAR}{#2}}{\ITEM{RAW}{#2}}}
\NewDocumentCommand{\NEWDRL}{s m}{\IfBooleanTF#1{\ITEM*{DRL}{#2}}{\ITEM{DRL}{#2}}}
\NewDocumentCommand{\NEWREC}{s m}{\IfBooleanTF#1{\ITEM*{REC}{#2}}{\ITEM{REC}{#2}}}
\NewDocumentCommand{\NEWQC}{s m}{\IfBooleanTF#1{\ITEM*{REC}{#2}}{\ITEM{REC}{#2}}}
\NewDocumentCommand{\NEWTPL}{s m}{\IfBooleanTF#1{\ITEM*{TPL}{#2}}{\ITEM{TPL}{#2}}}
\NewDocumentCommand{\NEWPROD}{s m}{\IfBooleanTF#1{\ITEM*{PROD}{#2}}{\ITEM{PROD}{#2}}}
\NewDocumentCommand{\NEWREQ}{s m}{\IfBooleanTF#1{\ITEM*{REQ}{#2}}{\ITEM{REQ}{#2}}}
\NewDocumentCommand{\NEWEXTCALIB}{s m}{\IfBooleanTF#1{\ITEM*{EXTCALIB}{#2}}{\ITEM{EXTCALIB}{#2}}}
\NewDocumentCommand{\NEWSTATCALIB}{s m}{\IfBooleanTF#1{\ITEM*{STATCALIB}{#2}}{\ITEM{STATCALIB}{#2}}}
\NewDocumentCommand{\NEWFITS}{s m}{\IfBooleanTF#1{\ITEM*{FITS}{#2}}{\ITEM{FITS}{#2}}}

%% Write DRL functions names like this: \hyperref[drl:function]{\DRL{function}}
\newcommand{\RAW}[1]{ \texorpdfstring{\lstinline[style=RAWstyle]!#1!}%
                                     {\replaceunderscores{#1}}}

%% Write DRL functions names like this: \hyperref[drl:function]{\DRL{function}}
\newcommand{\PAR}[1]{ \texorpdfstring{\lstinline[style=PARstyle]!#1!}%
                                     {\replaceunderscores{#1}}}

%% Write DRL functions names like this: \hyperref[drl:function]{\DRL{function}}
\newcommand{\DRL}[1]{ \texorpdfstring{\lstinline[style=DRLstyle]!#1!}%
                                     {\replaceunderscores{#1}}}

%% Write recipe names like this: \REC{metis_do_stuff}
\newcommand{\REC}[1]{ \texorpdfstring{\lstinline[style=RECstyle]!#1!}%
                                     {\replaceunderscores{#1}}}

%% Write QC parameters like this: \QC{QC_SOMETHING_OR_OTHER}
\newcommand{\QC}[1]{ \texorpdfstring{\lstinline[style=QCstyle]!#1!}%
                                    {\replaceunderscores{#1}}}

%% Write templates like this: \TPL{DARK_LM}
\newcommand{\TPL}[1]{ \texorpdfstring{\lstinline[style=TPLstyle]!#1!}%
                                     {\replaceunderscores{#1}}}

%% Write products like this: \hyperref[dataitem:some_thing]{\PROD{SOME_THING}}
\newcommand{\PROD}[1]{ \texorpdfstring{\lstinline[style=PRODstyle]!#1!}%
                                      {\replaceunderscores{#1}}}

%% Write requirements like this: \REQ{METIS-xxxx}
\newcommand{\REQ}[1]{\href{https://polarion.astron.nl/polarion/\#/project/METIS/workitem?id=#1}{\textcolor{brown}{#1}}}

%% external calib files
\newcommand{\EXTCALIB}[1]{ \texorpdfstring{\lstinline[style=EXTCALIBstyle]!#1!}%
                                          {\replaceunderscores{#1}}}

% static calib files
\newcommand{\STATCALIB}[1]{ \texorpdfstring{\lstinline[style=STATCALIBstyle]!#1!}%
                                           {\replaceunderscores{#1}}}

%% Write FITS keywords (and values) like this: \FITS{EXPTIME}
\newcommand{\FITS}[1]{ \texorpdfstring{\lstinline[]!#1!}%
                                      {\replaceunderscores{#1}}}

