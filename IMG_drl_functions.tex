\subsection{IMG observing mode}\label{sec:drl_functions_img}

%---------------------------------------------------------------------
\subsubsection{Function for basic processing}

\begin{recipedef}
Name: & \hyperref[drl:img_nonlinear_correction]{\DRL{img\_nonlinear\_correction}} \\
Purpose: &Correction for detector non-linearity\\
Used in recipes: & \hyperref[rec:metis_lm_img_basic_reduce]{\REC{metis_lm_img_basic_reduce}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Non-linearity corrected images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Correction of detector non-linearity \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}

\begin{recipedef}
Name: & \hyperref[drl:img_crosstalk_correction]{\DRL{img\_crosstalk\_correction}} \\
Purpose: &Correction for detector crosstalk\\
Used in recipes: & \hyperref[rec:metis_lm_img_basic_reduce]{\REC{metis_lm_img_basic_reduce}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Crosstalk corrected images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Correction of detector crosstalk \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\begin{recipedef}
Name: & \hyperref[drl:img_detrend]{\DRL{img\_detrend}} \\
Purpose: &Remove detector signals\\
Used in recipes: & \hyperref[rec:metis_lm_img_basic_reduce]{\REC{metis_lm_img_basic_reduce}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
&  \texttt{const ls\_master\_dark\_image * input} \\
&  \texttt{const ls\_master\_flat\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Detrended images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & De-trending the raw image \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\begin{recipedef}
Name: & \hyperref[drl:img_skybackground_build]{\DRL{img\_skybackground_build}} \\
Purpose: &Building thermal background signals\\
Used in recipes: & \hyperref[rec:metis_lm_img_background]{\REC{metis_lm_img_background}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
        & \texttt{const ls\_skybackground\_image} \\
        %\texttt{const ls\_master_dark_image * input} \\
    %\texttt{const ls\_master_flat_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Building sky background from images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Removing sky backround from images \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}
        
    

\begin{recipedef}
Name: & \hyperref[drl:img_skybackground_removal]{\DRL{img\_skybackground_removal}} \\
Purpose: &Remove sky background signals\\
Used in recipes: & \hyperref[rec:metis_lm_img_background]{\REC{metis_lm_img_background}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
      & \texttt{const ls\_skybackground\_image} \\
     %\texttt{const ls\_master_dark_image * input} \\
    %\texttt{const ls\_master_flat_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Removing sky background from images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Removing sky backround from images \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}
    


\subsubsection{Apply Persistance Correction}\label{drl:img_apply_persistence_correction}
\begin{recipedef}
Name: & \hyperref[drl:img_apply_persistence_correction]{\DRL{metis\_img\_apply_persistence_correction}} \\
Purpose: & Apply the persistence correction to raw images\\
Used in recipes: & \hyperref[sssec:lm_img_flatfield]{\REC{metis_lm_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
Other inputs: \PROD{PERSISTENCE_MAP} \\
QC outputs: ??\\
%Output FITS files: & None \\
Outputs: & Corrected raw images\\
         & \texttt{cpl\_error\_code} \\
General description: & Persistence correction of raw images \\
Mathematical description: & see Section~\ref{sec_persistence_correction} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}




\subsubsection{Create Master Flat}\label{drl:lm_img_flat}
\begin{recipedef}
Name: & \hyperref[drl:lm_img_flat]{\DRL{metis\_lm\_img_flat}} \\
Purpose: & Create master flat field for the LM-band imaging detector\\
Used in recipes: & \hyperref[sssec:lm_img_flatfield]{\REC{metis_lm_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
Other inputs: &  combination method (\texttt{median}, \texttt{mean}, \texttt{sigclip},\dots)\\
& parameters for combination method\\
&  \PROD{BADPIX_MAP_det}   \\
QC outputs: & QC LM MASTERFLAT RMS\\
%Output FITS files: & None \\
Outputs: & Master Flat\\
         & \texttt{cpl\_error\_code} \\
General description: & Determination of master flat for flat fielding \\
Mathematical description: & Combine images with the same DIT, fit slope of pixels against illumination level \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Flag Deviant Pixels in Dark Frame}\label{drl:lm_update_flat_mask}
\begin{recipedef}
Name: & \hyperref[drl:update_flat_mask]{\DRL{metis_update_flat_mask}} \\
Purpose: & Flag deviant pixels in the master flat and update the image mask\\
Used in recipes: & \hyperref[sssec:lm_img_flatfield]{\REC{metis_lm_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & flat \texttt{const hdrl\_image * input} \\
&  \PROD{BADPIX_MAP_det}   \\
& Threshold(s) for deviant pixel detection\\
QC outputs: & QC LM FLAT NBADPIX\\
& QC LM FLAT MEAN \#\#\\
& QC LM FLAT RMS \#\#\\
%Output FITS files: & None \\
         & Updated flat field mask\\
         & \texttt{cpl\_error\_code} \\
General description: &  Flag deviant pixels in master flat \\
Mathematical description: & flag pixels outside the provided threshold(s) \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Detect peak centroid location}\label{drl:img_peakcentroid}
\begin{recipedef}
Name: & \hyperref[drl:img_peakcentroid]{\DRL{detect\_centroid\_peak}} \\
Purpose: &Detect the location of a source peak by a centroid\\
Used in recipes: & \hyperref[rec:metisimgchophome]{\REC{metis_img_chophome}}\newline
\hyperref[rec:metislmadcmslitloss]{\REC{metis_lm_adc_slitloss}} \newline
\hyperref[rec:metisnadcmslitloss]{\REC{metis_n_adc_slitloss}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Location of detected peak [px]\\
               & \texttt{cpl\_error\_code} \\
General description: & Detection of a source by centroid fit \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}
