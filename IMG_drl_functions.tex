
\subsection{IMG observing mode}\label{sec:drl_functions_img}

%---------------------------------------------------------------------

%\subsubsection{Function for basic processing}

\subsubsection{Non-linearity Correction}\label{drl:img_nonlinear_correction}
\begin{recipedef}
Name: & \hyperref[drl:img_nonlinear_correction]{\DRL{img_nonlinear_correction}} \\
Purpose: &Correction for detector non-linearity\\
Used in recipes: & \hyperref[rec:metis_lm_img_basic_reduce]{\REC{metis_lm_img_basic_reduce}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Non-linearity corrected images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Correction of detector non-linearity \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}

\subsubsection{Crosstalk correction}\label{drl:img_crosstalk_correction}
\begin{recipedef}
Name: & \hyperref[drl:img_crosstalk_correction]{\DRL{img_crosstalk_correction}} \\
Purpose: &Correction for detector crosstalk\\
Used in recipes: & \hyperref[rec:metis_lm_img_basic_reduce]{\REC{metis_lm_img_basic_reduce}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Crosstalk corrected images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Correction of detector crosstalk \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Detrending}\label{drl:img_detrend}
\begin{recipedef}
Name: & \hyperref[drl:img_detrend]{\DRL{img_detrend}} \\
Purpose: &Remove detector signals\\
Used in recipes: & \hyperref[rec:metis_lm_img_basic_reduce]{\REC{metis_lm_img_basic_reduce}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
&  \texttt{const ls\_master\_dark\_image * input} \\
&  \texttt{const ls\_master\_flat\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Detrended images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & De-trending the raw image \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Building sky background}\label{drl:img_skybackground_build}
\begin{recipedef}
Name: & \hyperref[drl:img_skybackground_build]{\DRL{img_skybackground_build}} \\
Purpose: &Building thermal background signals\\
Used in recipes: & \hyperref[rec:metis_lm_img_background]{\REC{metis_lm_img_background}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
        & \texttt{const ls\_skybackground\_image} \\
        %\texttt{const ls\_master_dark_image * input} \\
    %\texttt{const ls\_master_flat_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Building sky background from images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Removing sky backround from images \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}
        
    
\subsubsection{Remove skybackground}\label{drl:img_skybackground_removal}
\begin{recipedef}
Name: & \hyperref[drl:img_skybackground_removal]{\DRL{img_skybackground_removal}} \\
Purpose: &Remove sky background signals\\
Used in recipes: & \hyperref[rec:metis_lm_img_background]{\REC{metis_lm_img_background}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
      & \texttt{const ls\_skybackground\_image} \\
     %\texttt{const ls\_master_dark_image * input} \\
    %\texttt{const ls\_master_flat_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Removing sky background from images [px]\\
                & \texttt{cpl\_error\_code} \\
General description: & Removing sky backround from images \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}
    


\subsubsection{Apply Persistance Correction}\label{drl:img_apply_persistence_correction}
\begin{recipedef}
Name: & \hyperref[drl:img_apply_persistence_correction]{\DRL{metis_img_apply_persistence_correction}} \\
Purpose: & Apply the persistence correction to raw images\\
Used in recipes: & \hyperref[sssec:lm_img_flatfield]{\REC{metis_lm_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
Other inputs: \hyperref[dataitem:persistence_map]{\PROD{PERSISTENCE_MAP}} \\
QC outputs: ??\\
%Output FITS files: & None \\
Outputs: & Corrected raw images\\
         & \texttt{cpl\_error\_code} \\
General description: & Persistence correction of raw images \\
Mathematical description: & see Section~\ref{sec_persistence_correction} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}




\subsubsection{Create Master LM Flat}\label{drl:lm_img_flat}
\begin{recipedef}
Name: & \hyperref[drl:lm_img_flat]{\DRL{metis_lm_img_flat}} \\
Purpose: & Create master flat field for the LM-band imaging detector\\
Used in recipes: & \hyperref[sssec:lm_img_flatfield]{\REC{metis_lm_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
Other inputs: &  combination method (\texttt{median}, \texttt{mean}, \texttt{sigclip},\dots)\\
& parameters for combination method\\
&  \hyperref[dataitem:badpix_map_lm]{\PROD{BADPIX_MAP_LM}}   \\
QC outputs: & QC LM MASTERFLAT RMS\\
%Output FITS files: & None \\
Outputs: & Master Flat\\
         & \texttt{cpl\_error\_code} \\
General description: & Determination of master flat for flat fielding \\
Mathematical description: & Combine images with the same DIT, fit slope of pixels against illumination level \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}

\subsubsection{Create N Master Flat}\label{drl:n_img_flat}
\begin{recipedef}
Name: & \hyperref[drl:n_img_flat]{\DRL{metis_n_img_flat}} \\
Purpose: & Create master flat field for the N-band imaging detector\\
Used in recipes: & \hyperref[sssec:n_img_flatfield]{\REC{metis_n_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
Other inputs: &  combination method (\texttt{median}, \texttt{mean}, \texttt{sigclip},\dots)\\
& parameters for combination method\\
&  \hyperref[dataitem:badpix_map_n]{\PROD{BADPIX_MAP_N}}   \\
QC outputs: & QC N MASTERFLAT RMS\\
%Output FITS files: & None \\
Outputs: & Master Flat\\
         & \texttt{cpl\_error\_code} \\
General description: & Determination of master flat for flat fielding \\
Mathematical description: & Combine images with the same DIT, fit slope of pixels against illumination level \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Flag Deviant Pixels in LM Flat Field}\label{drl:update_lm_flat_mask}
\begin{recipedef}
Name: & \hyperref[drl:update_lm_flat_mask]{\DRL{metis_update_lm_flat_mask}} \\
Purpose: & Flag deviant pixels in the LM master flat and update the image mask\\
Used in recipes: & \hyperref[sssec:lm_img_flatfield]{\REC{metis_lm_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & flat \texttt{const hdrl\_image * input} \\
&  \hyperref[dataitem:badpix_map_lm]{\PROD{BADPIX_MAP_LM}}   \\
& Threshold(s) for deviant pixel detection\\
QC outputs: & QC LM FLAT NBADPIX\\
            & QC LM FLAT MEAN \#\#\\
            & QC LM FLAT RMS \#\#\\
%Output FITS files: & None \\
Outputs:         & Updated flat field mask\\
                 & \texttt{cpl\_error\_code} \\
General description: &  Flag deviant pixels in master flat \\
Mathematical description: & flag pixels outside the provided threshold(s) \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}

\subsubsection{Flag Deviant Pixels in N Flat Field}\label{drl:update_n_flat_mask}
\begin{recipedef}
Name: & \hyperref[drl:update_n_flat_mask]{\DRL{metis_update_n_flat_mask}} \\
Purpose: & Flag deviant pixels in the N master flat and update the image mask\\
Used in recipes: & \hyperref[sssec:n_img_flatfield]{\REC{metis_n_img_flat}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & flat \texttt{const hdrl\_image * input} \\
&  \hyperref[dataitem:badpix_map_n]{\PROD{BADPIX_MAP_N}}   \\
& Threshold(s) for deviant pixel detection\\
QC outputs: & QC N FLAT NBADPIX\\
            & QC N FLAT MEAN \#\#\\
            & QC N FLAT RMS \#\#\\
%Output FITS files: & None \\
Outputs:         & Updated flat field mask\\
                 & \texttt{cpl\_error\_code} \\
General description: &  Flag deviant pixels in master flat \\
Mathematical description: & flag pixels outside the provided threshold(s) \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}




\subsubsection{metis\_derive\_gain}\label{drl:metis_derive_gain}
\begin{recipedef}
Name: & \hyperref[drl:metis_derive_gain]{\DRL{metis_derive_gain}} \\
Purpose: & Determine the gain. \\
Used in recipes: & \hyperref[sssec:metis_det_lingain]{\REC{metis_det_lingain}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const double * means} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & gain [\TODO{units}]\\
               & \texttt{cpl\_error\_code} \\
General description: & Determine the gain as the slope of variance against mean of detlin images. \\
Mathematical description: & TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & None. \\
%Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}
%---------------------------------------------------------------------
\subsubsection{metis\_derive\_nonlinearity}\label{drl:metis_derive_nonlinearity}
\begin{recipedef}
Name: & \hyperref[drl:metis_derive_nonlinearity]{\DRL{metis_derive_nonlinearity}} \\
Purpose: & Determine the non-linearity coefficients. \\
Used in recipes: & \hyperref[sssec:metis_det_lingain]{\REC{metis_det_lingain}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{hdrl\_image * image} Dark corrected non-linearity raws. \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & \hyperref[dataitem:linearity_det]{\PROD{LINEARITY_det}} \\
               & \texttt{cpl\_error\_code} \\
General description: & Determine the non-linearity coefficients. \\
Mathematical description: & \TODO{TBD} \\
Quality assessment: & Through QC parameters \\
Error conditions: & None. \\
%Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}

\subsubsection{Measure LM Band Flux of Standard Star}\label{drl:lm_calculate_std_flux}
\begin{recipedef}
Name: & \hyperref[drl:lm_calculate_std_flux]{\DRL{lm_calculate_std_flux}} \\
Purpose: & Calculate LM band flux and position of standard star in detector units \\
Used in recipes: & \hyperref[sssec:lm_img_photstd]{\REC{metis_lm_img_std_process}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & photometric standard catalogue \\
QC outputs: & \QC{QC LM IMG STD BACKGD RMS}\\
            & \QC{QC LM STD PEAK CNTS}\\
            & \QC{QC LM STD APERTURE CNTS}\\
            & \QC{QC LM STD STREHL}\\
            & \QC{QC LM STD AIRMASS}                                                       \\
%Output FITS files: & \hyperref[dataitem:lm_std_combined]{\PROD{LM_STD_COMBINED}} \\
Outputs: & position and flux of stars in detector units (hdrl\_catalogue\_result structure)  \\
               & \texttt{cpl\_error\_code} \\
General description: & Photometry of standard star \\
Mathematical description: & See Section~\ref{sssec:lm_img_photstd} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Measure N band Flux of Standard Star}\label{drl:n_std_flux}\label{drl:n_calculate_std_fluxl}
\begin{recipedef}
Name: & \hyperref[drl:n_calculate_std_fluxl]{\DRL{n_calculate_std_flux}} \\
Purpose: & Calculate N band flux and position of standard star in detector units \\
Used in recipes: & \hyperref[rec:metis_n_img_std_process]{\REC{metis_n_img_std_process}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \texttt{const hdrl\_image * input} \\
%Other inputs: & photometric standard catalogue \\
QC outputs: & \QC{QC N IMG STD BACKGD RMS}\\
            & \QC{QC N STD PEAK CNTS}\\
            & \QC{QC N STD APERTURE CNTS}\\
            & \QC{QC N STD STREHL}\\
            & \QC{QC N STD AIRMASS}                                                       \\
%Output FITS files: & \hyperref[dataitem:lm_std_combined]{\PROD{LM_STD_COMBINED}} \\
Outputs: & position and flux of stars in detector units (hdrl\_catalogue\_result structure)  \\
               & \texttt{cpl\_error\_code} \\
General description: & Photometry of standard star \\
Mathematical description: & See Section~\ref{n_img_std_process} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Recentre and Stack Images}\label{drl:recentre_img}
\begin{recipedef}
Name: & \hyperref[drl:recentre_img]{\DRL{recentre_img}} \\
Purpose: & Recentre images based on position of standard star, and stack \\
Used in recipes: & \hyperref[sssec:lm_img_photstd]{\REC{metis_lm_img_std_process}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
Other inputs: & position and flux of stars in detector units (hdrl\_catalogue\_result structure)\\
%QC outputs: & QC DET IMG STD BACKGD RMS\\
%            & QC DET STD PEAK CNTS\\
%            & QC DET STD APERTURE CNTS\\
%            & QC DET STD STREHL\\
Output FITS files: & \hyperref[dataitem:lm_std_combined]{\PROD{LM_STD_COMBINED}} \\
Outputs: & \texttt{cpl\_error\_code} \\
General description: & shifting and stacking of a sequence of images \\
Mathematical description: & See Section~\ref{sssec:lm_img_photstd} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}

\subsubsection{Calculate Flux Calibration}\label{drl:calculate_std_fluxcal}
\begin{recipedef}
Name: & \hyperref[drl:calculate_std_fluxcal]{\DRL{calculate_std_fluxcal}} \\
Purpose: & Calculate the conversion between instrumental and physical flux units \\
Used in recipes: & \hyperref[sssec:lm_img_photstd]{\REC{metis_lm_img_std_process}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & Flux of standard star in instrumental units \\
Other inputs: & photometric standard catalogue \\
%QC outputs: & QC DET IMG STD BACKGD RMS\\
%            & QC DET STD PEAK CNTS\\
%            & QC DET STD APERTURE CNTS\\
%            & QC DET STD STREHL\\
%Output FITS files: & \hyperref[dataitem:lm_std_combined]{\PROD{LM_STD_COMBINED}} \\
Outputs: & \hyperref[dataitem:fluxcal_tab]{\PROD{FLUXCAL_TAB}} \\
               & \texttt{cpl\_error\_code} \\
General description: & Calculate flux conversion to physical units \\
Mathematical description: & See Section~\ref{sssec:lm_img_photstd} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}

\subsubsection{Calculate Detection Limits}\label{drl:calculate_detection_limits}
\begin{recipedef}
Name: & \hyperref[drl:calculate_detection_limits]{\DRL{calculate_detection_limits}} \\
Purpose: & Calculate Detection Limits \\
Used in recipes: & \hyperref[sssec:lm_img_photstd]{\REC{metis_lm_img_std_process}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: &  \texttt{const hdrl\_image * input} \\
Other inputs: & \hyperref[dataitem:fluxcal_tab]{\PROD{FLUXCAL_TAB}} \\
QC outputs: & QC DET LM SENSITIVITY\\
            & QC DET LM AREA SENSITIVITY\\
%Output FITS files: & \hyperref[dataitem:lm_std_combined]{\PROD{LM_STD_COMBINED}} \\
Outputs: & detection limits for standard star  \\
               & \texttt{cpl\_error\_code} \\
General description: & Calculate detection limits of standard star \\
Mathematical description: & See Section~\ref{sssec:lm_img_photstd} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}



\subsubsection{Detect peak centroid location}\label{drl:img_peakcentroid}
\begin{recipedef}
Name: & \hyperref[drl:img_peakcentroid]{\DRL{detect_centroid_peak}} \\
Purpose: &Detect the location of a source peak by a centroid\\
Used in recipes: & \hyperref[rec:metisimgchophome]{\REC{metis_img_chophome}}\newline
\hyperref[rec:metislmadcmslitloss]{\REC{metis_lm_adc_slitloss}} \newline
\hyperref[rec:metisnadcmslitloss]{\REC{metis_n_adc_slitloss}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & $n\times$ \texttt{const hdrl\_image * input} \\
%Other inputs: & None \\
%QC outputs: & None\\
%Output FITS files: & None \\
Outputs: & Location of detected peak [px]\\
               & \texttt{cpl\_error\_code} \\
General description: & Detection of a source by centroid fit \\
Mathematical description: & see Section~\ref{sssec:centroid} TBD \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Convert LM Image to Physical Flux}\label{drl:lm_scale_image_flux}
\begin{recipedef}
Name: & \hyperref[drl:lm_scale_image_flux]{\DRL{lm_scale_image_flux}} \\
Purpose: & Calculate the conversion between instrumental and physical flux units \\
Used in recipes: & \hyperref[sssec:lm_img_calibrate]{\REC{metis_lm_img_cakubrate}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \hyperref[dataitem:lm_sci_bkg_subtracted]{\PROD{LM_SCI_BKG_SUBTRACTED}}\\
         \hyperref[dataitem:fluxcal_tab]{\PROD{FLUXCAL_TAB}} \\
Other inputs: & None \\
QC outputs: & None\\
%Output FITS files: & \hyperref[dataitem:lm_std_combined]{\PROD{LM_STD_COMBINED}} \\
Outputs: & \texttt{cpl\_error\_code} \\
General description: & Convert instrumental flux to ph/s \\
Mathematical description: & See Section~\ref{sssec:lm_img_calibrate} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}



\subsubsection{Add LM Calibration Information to Header}\label{drl:lm_update_header_distortion}
\begin{recipedef}
Name: & \hyperref[drl:lm_update_header_distortion]{\DRL{lm_update_header_distortion}} \\
Purpose: & Update the FITS header with calibration data (WCS, distortion, units)  \\
Used in recipes: & \hyperref[sssec:lm_img_calibrate]{\REC{metis_lm_img_calibrate}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: &   \hyperref[dataitem:lm_sci_bkg_subtracted]{\PROD{LM_SCI_BKG_SUBTRACTED}}\\
       &   \hyperref[dataitem:lm_distortion_table]{\PROD{LM_DISTORTION_TABLE}}\\
QC outputs: & None \\
Output FITS files: & \hyperref[dataitem:lm_sci_calibrated]{\PROD{LM_SCI_CALIBRATED}} \\
Outputs: & \texttt{cpl\_error\_code} \\
General description: & Add disortion, WCS and BUNIT information to FITS header \\
Mathematical description: & See Section~\ref{sssec:lm_img_calibrate} \\
Quality assessment: & None \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}


\subsubsection{Convert N Image to Physical Flux}\label{drl:n_scale_image_flux}
\begin{recipedef}
Name: & \hyperref[drl:n_scale_image_flux]{\DRL{n_scale_image_flux}} \\
Purpose: & Calculate the conversion between instrumental and physical flux units \\
Used in recipes: & \hyperref[sssec:n_img_calibrate]{\REC{metis_n_img_cakubrate}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: & \hyperref[dataitem:n_sci_bkg_subtracted]{\PROD{N_SCI_BKG_SUBTRACTED}}\\
         \hyperref[dataitem:fluxcal_tab]{\PROD{FLUXCAL_TAB}} \\
Other inputs: & None \\
QC outputs: & None\\
%Output FITS files: & \hyperref[dataitem:n_std_combined]{\PROD{N_STD_COMBINED}} \\
Outputs: & \texttt{cpl\_error\_code} \\
General description: & Convert instrumental flux to ph/s \\
Mathematical description: & See Section~\ref{sssec:n_img_calibrate} \\
Quality assessment: & Through QC parameters \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}



\subsubsection{Add N Calibration Information to Header}\label{drl:n_update_header_distortion}
\begin{recipedef}
Name: & \hyperref[drl:n_update_header_distortion]{\DRL{n_update_header_distortion}} \\
Purpose: & Update the FITS header with calibration data (WCS, distortion, units)  \\
Used in recipes: & \hyperref[sssec:n_img_calibrate]{\REC{metis_n_img_calibrate}}\\
%Working remarks: & None \\
%Function Parameters: & None \\
Input: &   \hyperref[dataitem:n_sci_bkg_subtracted]{\PROD{N_SCI_BKG_SUBTRACTED}}\\
       &   \hyperref[dataitem:n_distortion_table]{\PROD{N_DISTORTION_TABLE}}\\
QC outputs: & None \\
Output FITS files: & \hyperref[dataitem:n_sci_calibrated]{\PROD{N_SCI_CALIBRATED}} \\
Outputs: & \texttt{cpl\_error\_code} \\
General description: & Add disortion and BUNIT information to FITS header \\
Mathematical description: & See Section~\ref{sssec:n_img_calibrate} \\
Quality assessment: & None \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}



\subsubsection{Fit Distortion Parameters}\label{drl:fit_distortion}
\begin{recipedef}
Name: & \hyperref[drl:fit_distortion]{\DRL{fit_distortion}} \\
Purpose: & Fit optical distortion coefficients based on pinhole mask image  \\
Used in recipes: & \hyperref[sssec:lm_img_distortion]{\REC{metis_lm_img_distortion}}\\
                 & \hyperref[sssec:n_img_distortion]{\REC{metis_n_img_distortion}}\\
%Working remarks: & None \\
Function Parameters: & parameters for fitting routine \\
Input: &   Catalogue of detected sources \\
       &   \hyperref[dataitem:det_pinhole_table]{\PROD{det_PINHOLE_TABLE}}\\
QC outputs: & \QC{QC det DISTORT RMS}  \\
            & \QC{QC det DISTORT NSOURCE}  \\
Output FITS files: & \hyperref[dataitem:det_dist_reduced]{\PROD{det_DIST_REDUCED}}\\
                   & \hyperref[dataitem:det_distortion_map]{\PROD{det_DISTORTION_MAP}}\\
Outputs:  &  \hyperref[dataitem:det_distortion_table]{\PROD{det_DISTORTION_TABLE}} \\
          & \texttt{cpl\_error\_code} \\
General description: &  Fit optical distortion coefficients based on pinhole mask image \\
Mathematical description: & See Section~\ref{sssec:lm_img_distortion} \\
Quality assessment: & \TBD \\
Error conditions: & See \cite{DRLVT} (TBD). \\
Unit tests: & See \cite{DRLVT} (TBD). \\
\end{recipedef}
