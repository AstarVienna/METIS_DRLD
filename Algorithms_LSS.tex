\subsection{Long-slit spectroscopy mode}
\label{ssec:algo_lss_spectroscopy}

%-----------------------------------------------------------------------------------------
\subsubsection{Order background contamination removal}\label{ssec:orderbg}
Order background contamination may arise from internal straylight probably covering larger areas of the detector. Since it is expected to be low frequency only, its removal can be achieved by a low-order 2D polynomial fit 
\begin{equation}
    z = (a_0 + a_1x + a_2y + a_3x^2 + a_4x^2y + a_5x^2y^2 + a_6y^2 + a_7xy^2 + a_8xy ...)
\end{equation}
and a subsequent subtraction. The fitting points/regions must be chosen to be outside the \ac{LSS} order. Whereas these fitting points/regions can be chosen on fairly regular basis due to the straight order geometry in the \ac{LSS} mode, the degree of the polynomial depends on the actual straylight. This can be determined only during the testing phase when first real data are available.

%-----------------------------------------------------------------------------------------
\subsubsection{Order detection and rectification}\label{ssec:orderhandling}
The algorithms for order detection and rectification are adopted from \cite{pis02,pis21}.
In brief, the selection of pixels that may belong to spectral \ac{LSS} order is done by first smoothing each column and then selecting pixels above the median of the difference between the original
and the smoothed column, i.e. pixel $(x,y)$ is selected if
\begin{equation}
    I(x,y) > \bar{I}(x,y) + \mathrm{Median} ( I(x,y) - \bar{I}(x,y) ) .
\end{equation}
In the following a clustering analysis is performed, which associates connected groups of pixels. This is done scanning rows and columns and identifying neighbouring pixels selected in the previous step as belonging to the same cluster if $\delta x$ and $\delta y$ differ by at most 1. As spectral orders may be partitioned into different clusters because of e.g. detector defects, polynomial fits to the clusters are performed and the pairwise extensions of the fits to consecutive clusters are compared to identify which clusters are to be merged according to predefined criteria for the goodness of match. For each order, the detection algorithm yields a polynomial description of order location on the detector (the order center and its edges), an uncertainty estimate
for the fitted polynomial, and the first and last columns to be used during spectrum extraction. 
%The upper and lower edges of the orders are also traced and fitted by the order tracing algorithm using the pinhole frames with the flatfield lamp. 
Order rectification is achieved using the PyReduce algorithm described by \cite{pis21} that can account for both tilt and curvature of the slit image.   

%-----------------------------------------------------------------------------------------
\subsubsection{Wavelength calibration strategy}\label{ssec:wavecal}
\paragraph{Spectral resolving power}
We first estimate the spectral resolving power of the \ac{LSS} mode for the different slits incorporated in the spectrograph. More fancy text to follow \textit{Maybe that part should go somewhere else....}\cite{METIS-system_analysis}
\begin{table}
\begin{center}
\begin{tabular}{c|cccc|cc|cc}
Band & $\lambda_\textrm{min}$ & $\lambda_\textrm{cent}$ & $\lambda_\textrm{max}$ & $\Delta\lambda$  & $\lambda_\textrm{min}$ y-Pos & $\lambda_\textrm{min}$ y-Pos & Dispersion & Dispersion \\
 & [$\mu$m] & [$\mu$m] & [$\mu$m]& on chip [$\mu$m] & on chip [mm] & on chip [mm] & [$\mu$m/mm] & [$\mu$m/pixel]\\
\hline
L & 2.9 & 3.55 & 4.2 & 1.300 & 17.856 & -16.704 & 3.762e-02 & 6.771e-04 \\
M & 4.5 & 4.85 & 5.2 & 0.700 & 17.856 & -16.704 & 2.025e-02 & 3.646e-04 \\
N & 7.5 & 10.5 & 13.5 & 6.000 & -18.801 & 16.911 & 1.680e-01 & 3.024e-03 \\
\end{tabular}
\caption{Spectral dispersion of the long-slit spectrograph in all three bands\label{tab:bands_specres1}}
\end{center}
\end{table}

\begin{table}
\begin{center}
\begin{tabular}{c|cc|ccc|ccc}
 & & & proj. Slit & & & & & \\
Slit & Width$^a$ & Length$^a$ & $L$-band & $M$-band & $N$-band & $L$-band & $M$-band & $N$-band \\
ID & [mas] & [mas] & [pixel] & [pixel] & [pixel] & Resolution$^b$ & Resolution$^b$ & Resolution$^b$ \\
\hline
Slit A & 19.0 & 8000.0 & 2.352e-03 & 1.266e-03 & 8.621e-03 & 1509 & 3830 & 1218 \\
Slit B & 28.6 & 8000.0 & 3.540e-03 & 1.906e-03 & 1.298e-02 & 1003 & 2544 & 809 \\
Slit C & 38.1 & 8000.0 & 4.716e-03 & 2.539e-03 & 1.729e-02 & 752 & 1910 & 608 \\
Slit D & 57.1 & 8000.0 & 7.068e-03 & 3.806e-03 & 2.591e-02 & 502 & 1274 & 405 \\
Slit E & 114.2 & 8000.0 & 1.414e-02 & 7.612e-03 & 5.182e-02 & 251 & 637 & 203 \\
\end{tabular}
\caption{Estimate of the LSS spectral resolving power in all three bands with respect to the different slits;\newline $^a$ from Tab.~4-2 in \cite{METIS-system_analysis} \newline $^b$ at $\lambda_\textrm{cent}$ (see Tab.~\ref{tab:bands_specres1})\label{tab:bands_specres2}}
\end{center}
\end{table}


%-----------------------------------------------------------------------------------------
\subsubsection{Spectroscopic flux calibration strategy}\label{ssec:fluxcal}
Flux calibration implies the conversion of ADUs to physical units. This is done by comparing the observed spectrum of a standard star with its reference spectrum as seen without atmospheric and instrument/telescope signatures, facilitating the response function to be determined. The response function describes the optical throughput of the optical system, i.e. the instrumental effect on the flux. In principle this is a standard procedure and in \ac{METIS} basically the same approach as described in the \ac{HDRL} will be closely followed (cf. \cite{hdrl}). This method incorporates an automatic telluric correction of the standard star, which can be disabled. This might be useful in case the user decided to observe a dedicated \ac{TSS}. The recipes \REC{metis\_LM\_lss\_std} and \REC{metis\_N\_lss\_std} will derive a transmission function by means of the \ac{TSS}, which will be used for the telluric correction. The \c{TSS} might also be used for the response determination if possible.

%\textcolor{red}{TBD: slit flux losses due to PSF (cf. MICADO)?????}




%-----------------------------------------------------------------------------------------
\subsubsection{Object extraction and faint object spectroscopy}\label{sec:fospectro}
The object spectra will be extracted using the optimal extraction described by \cite{pis21} in order to maximized the \ac{SNR}. 
Faint objects will lead to additional requirements for the observation and the data reduction. For the target acquisition a blind offset from a reference source might become necessary in case the actual object cannot be detected directly. For the data reduction, manual interaction with the user is expected to be necessary to define the target position along the slit since automatic object detection algorithms (e.g. optimal extraction %\cite{hor86}) 
rely on a certain \ac{SNR}. This will be implemented as interactive actor in Reflex (or ESO-DPS).