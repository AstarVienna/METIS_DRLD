\clearpage
\section{Critical algorithms}\label{sec:critical_algorithms}

This section discusses the progress made on the critical algorithms identified in the Data Reduction Library Specifications document [AD1].

\begin{enumerate}
    \item Persistence correction
    \item Detector Masks
    \item Bad pixel determination
    \item Background subtraction
    \item Wavelength calibration and distortion correction
    \item Telluric correction
    \item Error propagation
    \item N-band image restoration
    \item LMS image and cube reconstruction
    \item LMS data rate
\end{enumerate}

The following additional critical algorithms were identified in the period between PDR and FDR:

\begin{enumerate}
    \item ADI algorithm
\end{enumerate}

% Export these to individual files if they become too wordy
\subsection{Persistence correction}

Will have access to a HDRL function from ESO. 
The interface is TBD.
Subtraction of persistence image as determined by ESO.
Need to reference ESO docs for this.
How does the scaling happen?
Is there an API endpoint for this?

\subsection{Detector Masks}

Look into the MATISSE docs as to how this was done
Delivers a bias/dark/ron value?

\subsection{Bad pixel determination}

Surely every other instrument on planet earth has some sort of algo for this.
Need to determine the format of the bad pixel mask (bool?)
Take XSHOOTER as example

\subsection{Background subtraction}

N-band: Standard chop and nod using telescope chopper and internal nodder
See VISIR pipeline

\subsection{Wavelength calibration and distortion correction}

Pyreduce, will be described by Nadeen
IMG modes are not critical, see recipes

\subsection{Telluric correction}
Telluric correction, i.e. the removal of absorption features arising in the Earth's atmosphere, is a critical issue as the imprint of molecular species present in our air may vary on different timescales down to minutes due to changes in their composition and their amount. In particular the \ac{MIR} range is affected (see App~\ref{app:atmo_trans}).\\
There are two well established ways to correct for these absorptions:
\begin{itemize}
    \item \textit{Classical approach}: A telluric standard star (\ac{TSS}) spectrum is taken ideally directly before/after the science observations at the same airmass. This \ac{TSS}-spectrum is processed in the same way as the science spectrum (except the absolute flux calibration) and finally its continuum is normalised to unity. In addition, a model of this specific \ac{TSS} spectrum is used to remove intrinsic spectral features. The remaining normalised spectrum (ideally) only contains the fingerprint of the Earth's atmospheric absorptions and can be used for the telluric correction. In case the model spectrum also contains absolute flux values, this star could also be used for the absolute flux calibration.
    \item \textit{Modelling approach}: In the last years a new method has evolved which is based on radiative transfer modelling of the Earth's atmosphere (\cite{mf1, mf2, molecfit}\footnote{\url{https://www.eso.org/sci/software/pipelines/skytools/molecfit}}). A model of the Earth's atmosphere in combination with a radiative transfer model and a molecular line list containing lines of various species is used to determine the transmission of the Earth's atmosphere at the time of observations by fitting specific molecular absorption features in the science spectra. The best-fit transmission function is finally used for the telluric correction.
\end{itemize}
These two methods can also be combined in the way that the modelling approach is applied to a \ac{TSS} spectrum, and the resulting transmission function is then applied to the science spectrum. This combination is specifically useful if the science target continuum is too weak to use the absorptions for a fit.\\
For the \ac{METIS} pipelines we intend to incorporate both ways (including their combination). A detailed description is given in Section~\ref{ssec:tellcorr}). As both methods are well established, we deem a dedicated prototyping not necessary.

\subsection{Error propagation}

HDRL functions do error propogation. Look into docs for these. 
Understand how HDRL does this and then copy it.

\subsection{N-band image restoration}

Chop-nod inversion and stacking
Look at how VISIR does this
Need to look at sub-pixel chop shifts, and whether the images need to be resampled
Plate scale distortions are not really a issue, because we only care about compact objects

\subsection{LMS image and cube reconstruction}

Completely open and a bit of a beast. 
Help from Linz?
Drizzling from HST?

\subsection{LMS data rate}

See data rate document. 
Hand-wave-y arguments to make this go away.

% Additional critical algos
\input{CritAlgo_ADI}
